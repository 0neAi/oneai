<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" href="./images/logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --dark-color: #5a5c69;
            --light-bg: #f8f9fc;
            --dark-bg: #1a1a2e;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        #admin-app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .main-content {
            flex: 1;
        }
        
        .stat-card {
            border-radius: 0.5rem;
            color: white;
            padding: 1.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1.5rem rgba(58, 59, 69, 0.2);
        }
        
        .bg-primary { background-color: var(--primary-color)!important; }
        .bg-success { background-color: var(--success-color)!important; }
        .bg-warning { background-color: var(--warning-color)!important; }
        .bg-danger { background-color: var(--danger-color)!important; }
        .bg-info { background-color: #0dcaf0!important; }
        .bg-dark { background-color: var(--dark-bg)!important; }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), #2a4cb2);
            color: white;
            border-radius: 0.35rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .table-responsive {
            max-height: 500px;
        }
        
        .action-cell {
            min-width: 150px;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #0dcaf0);
            color: white;
        }
        
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1.5rem rgba(58, 59, 69, 0.2);
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        
        .status-badge {
            padding: 0.35em 0.65em;
            border-radius: 0.25rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .issue-card {
            border-left: 4px solid;
            margin-bottom: 1rem;
            background-color: white;
            border-radius: 0.35rem;
            overflow: hidden;
        }
        
        .issue-card.low {
            border-left-color: #28a745;
        }
        
        .issue-card.medium {
            border-left-color: #ffc107;
        }
        
        .issue-card.high {
            border-left-color: #dc3545;
        }
        
        .issue-card .card-body {
            padding: 1rem;
        }
        
        .issue-card .meta {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .issue-card .actions {
            margin-top: 1rem;
        }
        
        .issue-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 0.5rem;
            background-color: #e9ecef;
        }
        
        .issue-status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }
        
        .status-in-progress {
            background-color: #17a2b8;
            color: white;
        }
        
        .status-resolved {
            background-color: #28a745;
            color: white;
        }
        
        .status-rejected {
            background-color: #dc3545;
            color: white;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: transparent;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-content {
            padding: 1.5rem 0;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 1.5rem;
        }
        
        .main-container {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-top: 1rem;
        }
        
        .nav-brand {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div id="admin-app">
        <!-- Loading Overlay -->
        <div v-if="isLoading" class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="ms-3">Loading Admin Data...</p>
        </div>

        <!-- Initial Setup -->
        <div v-if="showInitialSetup" class="text-center py-5">
            <div class="d-flex justify-content-center mb-4">
                <div class="nav-brand">Admin Panel</div>
            </div>
            <div class="auth-container">
                <h3 class="mb-4">Create First Admin</h3>
                <form @submit.prevent="registerAdmin">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input id="email" type="email" class="form-control" 
                               v-model="admin.email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input id="password" type="password" class="form-control"
                               v-model="admin.password" required minlength="12">
                        <small class="text-muted">Minimum 12 characters with uppercase, lowercase, number and special character</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <span v-if="!registerLoading">Create Admin Account</span>
                        <span v-else class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    </button>
                    <div v-if="registerError" class="alert alert-danger mt-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ registerError }}
                    </div>
                    <div v-if="registerSuccess" class="alert alert-success mt-3">
                        <i class="bi bi-check-circle-fill me-2"></i>{{ registerSuccess }}
                    </div>
                </form>
            </div>
        </div>

        <!-- Login Form -->
        <div v-else-if="!isAuthenticated" class="d-flex align-items-center justify-content-center vh-100">
            <div class="card p-4" style="width: 100%; max-width: 400px;">
                <h3 class="card-title text-center">Admin Login</h3>
                <div v-if="loginError" class="alert alert-danger">{{ loginError }}</div>
                <form @submit.prevent="login">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="login-email" v-model="admin.email" required>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="login-password" v-model="admin.password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <span v-if="!loginLoading">Login</span>
                        <span v-else class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div v-else class="main-content p-4">
            <!-- Navigation -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 rounded">
                <div class="container-fluid">
                    <span class="navbar-brand">
                        <i class="bi bi-shield-lock me-2"></i>Admin Dashboard
                    </span>
                    <div class="d-flex align-items-center">
                        <span class="text-light me-3">
                            <i class="bi bi-person-circle me-1"></i> {{ admin.email }}
                        </span>
                        <button class="btn btn-outline-light" @click="logout">
                            <i class="bi bi-box-arrow-right me-1"></i>Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h3><i class="bi bi-speedometer2 me-2"></i> Dashboard Overview</h3>
                <p class="mb-0">Monitor and manage your platform activities</p>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card bg-primary">
                        <i class="bi bi-people-fill fs-1"></i>
                        <div class="number">{{ stats.totalUsers }}</div>
                        <div class="label">Total Users</div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card bg-success">
                        <i class="bi bi-credit-card-fill fs-1"></i>
                        <div class="number">{{ stats.totalPayments }}</div>
                        <div class="label">Total Payments</div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card bg-info">
                        <i class="bi bi-cash-stack fs-1"></i>
                        <div class="number">৳{{ totalPaymentAmount.toFixed(2) }}</div>
                        <div class="label">Total Amount</div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card bg-warning">
                        <i class="bi bi-hourglass-split fs-1"></i>
                        <div class="number">{{ stats.pendingPayments }}</div>
                        <div class="label">Pending Payments</div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-3">
                    <div class="stat-card bg-danger">
                        <i class="bi bi-exclamation-triangle-fill fs-1"></i>
                        <div class="number">{{ stats.issueReports }}</div>
                        <div class="label">Issue Reports</div>
                    </div>
                </div>
            </div>

            <div class="main-container">
                <!-- Payments Section -->
                <div class="card shadow-sm mb-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Recent Payments</h5>
                        <div class="d-flex">
                            <select v-model="paymentFilter" class="form-select form-select-sm w-auto me-2">
                                <option value="all">All</option>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                                <option value="Failed">Failed</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" @click="refreshPayments">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>TRX ID</th>
                                        <th>User</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="payment in filteredPayments" :key="payment._id">
                                        <td>{{ payment.trxid }}</td>
                                        <td>
                                            <span v-if="payment.user">{{ payment.user.email }}</span>
                                            <span v-else class="text-muted">N/A</span>
                                        </td>
                                        <td>{{ formatDateTime(payment.createdAt) }}</td>
                                        <td>৳{{ payment.amount3.toFixed(2) }}</td>
                                        <td>
                                            <span class="status-badge" :class="statusClass(payment.status)">
                                                {{ payment.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1 btn-action" 
                                                    @click="showPaymentDetails(payment)"
                                                    title="View Details">
                                                <i class="bi bi-eye-fill"></i>
                                            </button>
                                            <button v-if="payment.status === 'Pending'" class="btn btn-sm btn-outline-success btn-action me-1" 
                                                    @click="approvePayment(payment)"
                                                    title="Approve Payment">
                                                <i class="bi bi-check2-circle"></i>
                                            </button>
                                            <button v-if="payment.status === 'Pending'" class="btn btn-sm btn-outline-danger btn-action" 
                                                    @click="rejectPayment(payment)"
                                                    title="Reject Payment">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger btn-action" 
                                                    @click="deleteItem('payment', payment._id)"
                                                    title="Delete Payment">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredPayments.length === 0">
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            No payments found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Merchant Issues Section -->
                <div class="card shadow-sm mb-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Merchant Issues</h5>
                        <div class="d-flex">
                            <select v-model="issueFilter" class="form-select form-select-sm w-auto me-2">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" @click="refreshIssues">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="issueTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" 
                                        data-bs-target="#all-issues" type="button" role="tab">
                                    All Issues
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" 
                                        data-bs-target="#issue-stats" type="button" role="tab">
                                    Statistics
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="issueTabContent">
                            <div class="tab-pane fade show active" id="all-issues" role="tabpanel">
                                <div v-if="filteredIssues.length === 0" class="text-center py-4 text-muted">
                                    No issues found
                                </div>
                                
                                <div v-for="issue in filteredIssues" :key="issue.id" 
                                     class="issue-card">
                                    <div class="card-body">
                                        <h5>{{ issue.merchantName }}</h5>
                                        <div class="meta mb-2">
                                            <span class="issue-type-badge">{{ issue.issueType }}</span>
                                            <span class="issue-status-badge" :class="'status-' + issue.status.replace(' ', '-')">
                                                {{ issue.status }}
                                            </span>
                                            <span class="ms-2">{{ formatDateTime(issue.createdAt) }}</span>
                                        </div>
                                        <p class="mb-2"><strong>Phone:</strong> {{ issue.merchantPhone }}</p>
                                        <p>{{ issue.details }}</p>
                                        
                                        <div class="actions">
                                            <button class="btn btn-sm btn-outline-primary me-2" 
                                                    @click="showIssueDetails(issue)">
                                                <i class="bi bi-eye me-1"></i>Details
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-2" 
                                                    @click="updateIssueStatus(issue, 'in-progress')"
                                                    v-if="issue.status === 'pending'">
                                                <i class="bi bi-play me-1"></i>Start Progress
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-2" 
                                                    @click="showApproveIssueModal(issue)"
                                                    v-if="issue.status === 'in-progress'">
                                                <i class="bi bi-check me-1"></i>Approve
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    @click="updateIssueStatus(issue, 'rejected')"
                                                    v-if="issue.status !== 'rejected' && issue.status !== 'resolved'">
                                                <i class="bi bi-x me-1"></i>Reject
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger ms-2" 
                                                    @click="deleteItem('merchant issue', issue._id)"
                                                    title="Delete Issue">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="issue-stats" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h5>Issues by Status</h5>
                                                <div class="chart-container">
                                                    <canvas id="issueStatusChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h5>Issues by Type</h5>
                                                <div class="chart-container">
                                                    <canvas id="issueTypeChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5>Recent Activity</h5>
                                        <ul class="list-group">
                                            <li v-for="activity in recentActivities" :key="activity.id" 
                                                class="list-group-item">
                                                <small class="text-muted">{{ formatDateTime(activity.timestamp) }}</small><br>
                                                {{ activity.message }}
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Penalty Reports Section -->
                <div class="card shadow-sm mb-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-exclamation-circle me-2"></i>Penalty Reports</h5>
                        <div class="d-flex">
                            <select v-model="penaltyFilter" class="form-select form-select-sm w-auto me-2">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="processed">Processed</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" @click="refreshPenalties">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Merchant</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="report in filteredPenalties" :key="report._id">
                                        <td>{{ report.merchantName }}</td>
                                        <td>{{ report.customerName }}</td>
                                        <td>{{ report.amount1 }} → {{ report.amount2 }}</td>
                                        <td>{{ formatDate(report.penaltyDate) }}</td>
                                        <td>{{ report.status }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1"
                                                    @click="showPenaltyDetails(report)">
                                                <i class="bi bi-eye me-1"></i>Details
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-1"
                                                    @click="showProcessPenaltyModal(report)"
                                                    v-if="report.status === 'pending'">
                                                <i class="bi bi-check me-1"></i>Process
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger"
                                                    @click="updatePenaltyStatus(report, 'rejected')"
                                                    v-if="report.status !== 'rejected' && report.status !== 'processed'">
                                                <i class="bi bi-x me-1"></i>Reject
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger ms-2"
                                                    @click="deleteItem('penalty report', report._id)"
                                                    title="Delete Report">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredPenalties.length === 0">
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            No penalty reports found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Registered Users</h5>
                        <button class="btn btn-sm btn-outline-primary" @click="refreshUsers">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Referral Code</th>
                                        <th>Referred By</th>
                                        <th>Total Payments</th>
                                        <th>Total Amount</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="user in users" :key="user.id">
                                        <td class="text-muted">{{ shortId(user._id) }}</td>
                                        <td>{{ user.phone }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            <span v-if="user.referralCode">{{ user.referralCode }}</span>
                                            <button v-else class="btn btn-sm btn-outline-success" @click="generateReferralCode(user)">
                                                Generate
                                            </button>
                                        </td>
                                        <td>{{ user.referredBy ? user.referredBy.name : 'N/A' }}</td>
                                        <td>{{ user.totalPayments }}</td>
                                        <td>৳{{ user.totalAmount ? user.totalAmount.toFixed(2) : '0.00' }}</td>
                                        <td>{{ formatDateTime(user.createdAt) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" @click="viewUserDetails(user._id)">
                                                <i class="bi bi-eye-fill me-1"></i>Details
                                            </button>
                                            <button v-if="!user.isApproved" class="btn btn-sm btn-outline-success" @click="showApproveUserModal(user)">
                                                Approve
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger ms-2" 
                                                    @click="deleteItem('user', user._id)"
                                                    title="Delete User">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="users.length === 0">
                                        <td colspan="5" class="text-center py-4 text-muted">
                                            No users found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Premium Payments Section -->
                <div class="card shadow-sm mt-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-gem me-2"></i>Premium Payments</h5>
                        <button class="btn btn-sm btn-outline-primary" @click="refreshPremiumPayments">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>TRX ID</th>
                                        <th>Phone</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="payment in premiumPayments" :key="payment._id">
                                        <td>{{ payment.trxid }}</td>
                                        <td>{{ payment.phone }}</td>
                                        <td>৳{{ payment.amount.toFixed(2) }}</td>
                                        <td>{{ formatDateTime(payment.createdAt) }}</td>
                                        <td>
                                            <span class="status-badge" :class="statusClass(payment.status)">
                                                {{ payment.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-success" @click="showProcessPremiumModal(payment)" v-if="payment.status === 'Pending'">
                                                <i class="bi bi-check-circle"></i> Process
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="updatePremiumPaymentStatus(payment, 'Failed')">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="premiumPayments.length === 0">
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            No premium payments found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- User Payment Calculator -->
                <div class="card shadow-sm mt-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>User Payment Calculator</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="Enter user email" v-model="userEmailQuery">
                            <input type="date" class="form-control" v-model="paymentStartDate">
                            <input type="date" class="form-control" v-model="paymentEndDate">
                            <button class="btn btn-primary" type="button" @click="calculateUserPayments">Calculate</button>
                        </div>
                        <div v-if="userPaymentData">
                            <h5>Payment details for {{ userPaymentData.user.email }}</h5>
                            <p><strong>Total Amount:</strong> ৳{{ userPaymentData.totalAmount.toFixed(2) }}</p>
                            <p><strong>Total Payments:</strong> {{ userPaymentData.totalPayments }}</p>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="payment in userPaymentData.payments" :key="payment._id">
                                        <td>{{ formatDateTime(payment.createdAt) }}</td>
                                        <td>৳{{ payment.amount3.toFixed(2) }}</td>
                                        <td>{{ payment.status }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-if="userPaymentError" class="alert alert-danger mt-3">
                            {{ userPaymentError }}
                        </div>
                    </div>
                </div>

                <!-- Manual Premium Voucher Generation Section -->
                <div class="card shadow-sm mt-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-ticket-perforated me-2"></i>Manual Premium Voucher Generation</h5>
                    </div>
                    <div class="card-body">
                        <form @submit.prevent="generatePremiumVoucher">
                            <div class="mb-3">
                                <label for="manual-premium-phone" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="manual-premium-phone" v-model="manualPremiumPhoneNumber" placeholder="Enter phone number" required>
                            </div>
                            <div class="mb-3">
                                <label for="premium-discount-percentage" class="form-label">Discount Percentage</label>
                                <input type="number" class="form-control" id="premium-discount-percentage" v-model.number="manualPremiumDiscountPercentage" min="0" max="100">
                            </div>
                            <div class="mb-3">
                                <label for="premium-validity" class="form-label">Validity Period</label>
                                <select class="form-select" id="premium-validity" v-model="manualPremiumValidity">
                                    <option value="1d">1 Day</option>
                                    <option value="2d">2 Days</option>
                                    <option value="3d">3 Days</option>
                                    <option value="15d">15 Days</option>
                                    <option value="1m">1 Month</option>
                                    <option value="3m">3 Months</option>
                                    <option value="lifetime">Lifetime</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span v-if="!generatingPremiumVoucher">Generate Voucher</span>
                                <span v-else class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            </button>
                            <div v-if="premiumVoucherMessage" :class="{'alert-success': premiumVoucherSuccess, 'alert-danger': !premiumVoucherSuccess}" class="alert mt-3">
                                {{ premiumVoucherMessage }}
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Fexiload Requests Section -->
                <div class="card shadow-sm mt-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-phone me-2"></i>Fexiload Requests</h5>
                        <button class="btn btn-sm btn-outline-primary" @click="refreshFexiloadRequests">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>User</th>
                                        <th>GP Number</th>
                                        <th>Amount/Offer</th>
                                        <th>Retail Charge</th>
                                        <th>Payment Method</th>
                                        <th>TRX ID</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="request in fexiloadRequests" :key="request._id">
                                        <td>
                                            <span v-if="request.userId">{{ request.userId.email }}</span>
                                            <span v-else class="text-muted">N/A</span>
                                        </td>
                                        <td>{{ request.gpNumber }}</td>
                                        <td>{{ request.rechargeAmount }}</td>
                                        <td>{{ request.retailCharge.toFixed(2) }}</td>
                                        <td>{{ request.method }}</td>
                                        <td>{{ request.transactionNumber }}</td>
                                        <td>{{ formatDateTime(request.createdAt) }}</td>
                                        <td>
                                            <span class="status-badge" :class="statusClass(request.status)">
                                                {{ request.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-success" @click="updateFexiloadRequestStatus(request, 'Completed')" v-if="request.status === 'Pending'">
                                                <i class="bi bi-check-circle"></i> Complete
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="updateFexiloadRequestStatus(request, 'Failed')" v-if="request.status === 'Pending'">
                                                <i class="bi bi-x-circle"></i> Fail
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger ms-1" @click="deleteItem('fexiload request', request._id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Location Tracker Requests Section -->
                <div class="card shadow-sm mt-5">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Location Tracker Requests</h5>
                        <button class="btn btn-sm btn-outline-primary" @click="refreshLocationTrackerRequests">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>User</th>
                                        <th>Source Type</th>
                                        <th>IMEI/Phone</th>
                                        <th>Service Types</th>
                                        <th>Charge</th>
                                        <th>TRX ID</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="request in locationTrackerRequests" :key="request._id">
                                        <td>
                                            <span v-if="request.user">{{ request.user.email }}</span>
                                            <span v-else class="text-muted">N/A</span>
                                        </td>
                                        <td>{{ request.sourceType }}</td>
                                        <td>
                                            <span v-if="request.imei">{{ request.imei }}</span>
                                            <span v-else-if="request.phoneNumber">{{ request.phoneNumber }}</span>
                                            <span v-else class="text-muted">N/A</span>
                                        </td>
                                        <td>{{ request.serviceTypes.join(', ') }}</td>
                                        <td>৳{{ request.serviceCharge.toFixed(2) }}</td>
                                        <td>{{ request.trxId }}</td>
                                        <td>
                                            <span class="status-badge" :class="statusClass(request.status)">
                                                {{ request.status }}
                                            </span>
                                        </td>
                                        <td>{{ formatDateTime(request.createdAt) }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" @click="showLocationTrackerRequestDetails(request)">
                                                <i class="bi bi-eye-fill"></i> Details
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-1" @click="updateLocationTrackerRequestStatus(request, 'Approved')" v-if="request.status === 'Pending'">
                                                <i class="bi bi-check-circle"></i> Approve
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger me-1" @click="updateLocationTrackerRequestStatus(request, 'Rejected')" v-if="request.status === 'Pending'">
                                                <i class="bi bi-x-circle"></i> Reject
                                            </button>
                                            <button class="btn btn-sm btn-outline-info me-1" @click="showDeliverDataModal(request)" v-if="request.status === 'Approved' || request.status === 'Pending'">
                                                <i class="bi bi-box-arrow-in-right"></i> Deliver Data
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="deleteItem('location tracker request', request._id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="locationTrackerRequests.length === 0">
                                        <td colspan="9" class="text-center py-4 text-muted">
                                            No location tracker requests found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Details Modal -->
        <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Payment Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedPayment">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Payment ID</label>
                                        <input type="text" class="form-control" :value="selectedPayment.id" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <input type="text" class="form-control" 
                                               :class="statusClass(selectedPayment.status)"
                                               :value="selectedPayment.status" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">User Email</label>
                                        <input type="text" class="form-control" 
                                               :value="(selectedPayment.user && selectedPayment.user.email) || 'N/A'" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Transaction ID</label>
                                        <input type="text" class="form-control" :value="selectedPayment.trxid" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Company</label>
                                        <input type="text" class="form-control" :value="selectedPayment.company" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Phone</label>
                                        <input type="text" class="form-control" :value="selectedPayment.phone" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Password</label>
                                        <input type="text" class="form-control" :value="selectedPayment.password" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Server Charge</label>
                                        <input type="text" class="form-control" :value="selectedPayment.amount3.toFixed(2)" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Discounted Amount</label>
                                        <input type="text" class="form-control" :value="(selectedPayment.amount3 * (1 - selectedPayment.discount / 100)).toFixed(2)" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Discount Percentage</label>
                                        <input type="text" class="form-control" :value="selectedPayment.discount + '%'" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="mt-4 mb-3">Consignments</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Original Amount</th>
                                            <th>Updated Amount</th>
                                            <th>Service</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(consignment, index) in selectedPayment.consignments" :key="index">
                                            <td>{{ consignment.name }}</td>
                                            <td>{{ consignment.phone }}</td>
                                            <td>৳{{ consignment.amount1.toFixed(2) }}</td>
                                            <td>৳{{ consignment.amount2.toFixed(2) }}</td>
                                            <td>{{ consignment.serviceType }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Details Modal -->
        <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Issue Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedIssue">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Merchant Name</label>
                                        <input type="text" class="form-control" :value="selectedIssue.merchantName" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Merchant Phone</label>
                                        <input type="text" class="form-control" :value="selectedIssue.merchantPhone" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Issue Type</label>
                                        <input type="text" class="form-control" :value="selectedIssue.issueType" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Details</label>
                                <textarea class="form-control" rows="4" readonly>{{ selectedIssue.details }}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" v-model="selectedIssue.status">
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            
                            <div v-if="selectedIssue.voucherCode" class="mb-3">
                                <label class="form-label">Voucher Code</label>
                                <input type="text" class="form-control" :value="selectedIssue.voucherCode" readonly>
                            </div>
                            <div v-if="selectedIssue.voucherCode" class="mb-3">
                                <label class="form-label">Discount Percentage</label>
                                <input type="text" class="form-control" :value="selectedIssue.discountPercentage + '%'" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" @click="saveIssueChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Penalty Details Modal -->
        <div class="modal fade" id="penaltyModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Penalty Report Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedPenalty">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Merchant Name</label>
                                        <input type="text" class="form-control" :value="selectedPenalty.merchantName" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Customer Name</label>
                                        <input type="text" class="form-control" :value="selectedPenalty.customerName" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Customer Phone</label>
                                        <input type="text" class="form-control" :value="selectedPenalty.customerPhone" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Penalty Date</label>
                                        <input type="text" class="form-control" :value="formatDate(selectedPenalty.penaltyDate)" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Original Amount</label>
                                        <input type="text" class="form-control" :value="selectedPenalty.amount1" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Updated Amount</label>
                                        <input type="text" class="form-control" :value="selectedPenalty.amount2" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Penalty Details</label>
                                <textarea class="form-control" rows="4" readonly>{{ selectedPenalty.penaltyDetails }}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" v-model="selectedPenalty.status">
                                    <option value="pending">Pending</option>
                                    <option value="processed">Processed</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            
                            <div v-if="selectedPenalty.voucherCode" class="mb-3">
                                <label class="form-label">Voucher Code</label>
                                <input type="text" class="form-control" :value="selectedPenalty.voucherCode" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" @click="savePenaltyChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Penalty Modal -->
        <div class="modal fade" id="processPenaltyModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Process Penalty & Generate Voucher</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedPenalty">
                            <p><strong>Merchant:</strong> {{ selectedPenalty.merchantName }}</p>
                            <div class="mb-3">
                                <label for="discount-percentage" class="form-label">Discount Percentage</label>
                                <input type="number" class="form-control" id="discount-percentage" v-model.number="discountPercentage" min="1" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="processPenalty">Generate Voucher</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approve Issue Modal -->
        <div class="modal fade" id="approveIssueModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Approve Issue & Generate Voucher</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedIssue">
                            <p><strong>Merchant:</strong> {{ selectedIssue.merchantName }}</p>
                            <div class="mb-3">
                                <label for="issue-discount-percentage" class="form-label">Discount Percentage</label>
                                <input type="number" class="form-control" id="issue-discount-percentage" v-model.number="issueDiscountPercentage" min="1" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="approveIssue">Generate Voucher</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Details Modal -->
        <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">User Details: {{ selectedUserDetail ? selectedUserDetail.name : '' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedUserDetail">
                            <h6>Personal Information</h6>
                            <p><strong>Name:</strong> {{ selectedUserDetail.name }}</p>
                            <p><strong>Email:</strong> {{ selectedUserDetail.email }}</p>
                            <p><strong>Phone:</strong> {{ selectedUserDetail.phone }}</p>
                            <p><strong>Zilla:</strong> {{ selectedUserDetail.zilla }}</p>
                            <p><strong>Office Location:</strong> {{ selectedUserDetail.officeLocation }}</p>
                            <p><strong>Referral Code:</strong> {{ selectedUserDetail.referralCode }}</p>
                            <p><strong>Admin Approved:</strong> {{ selectedUserDetail.isApproved ? 'Yes' : 'No' }}</p>
                            <p><strong>Registered On:</strong> {{ formatDateTime(selectedUserDetail.createdAt) }}</p>

                            <h6 class="mt-4">Referral Information</h6>
                            <p v-if="selectedUserDetail.referredBy">
                                <strong>Referred By:</strong> {{ selectedUserDetail.referredBy.name }} ({{ selectedUserDetail.referredBy.email }})
                            </p>
                            <p v-else>Not referred by anyone.</p>
                            <p><strong>Referral Commission Percentage:</strong> {{ selectedUserDetail.referralCommissionPercentage }}%</p>
                            <p><strong>Total Referrals:</strong> {{ selectedUserDetail.referrals ? selectedUserDetail.referrals.length : 0 }}</p>
                            <p v-if="selectedUserDetail.monthlyCommission !== undefined">
                                <strong>Monthly Commission (This Month):</strong> ৳{{ selectedUserDetail.monthlyCommission.toFixed(2) }}
                            </p>

                            <h6 class="mt-4">Payments</h6>
                            <div v-if="selectedUserDetail.payments && selectedUserDetail.payments.length > 0">
                                <p><strong>Total Payments (Completed):</strong> {{ selectedUserDetail.totalPayments }}</p>
                                <p><strong>Total Amount (Completed):</strong> ৳{{ selectedUserDetail.totalAmount.toFixed(2) }}</p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>TRX ID</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="payment in selectedUserDetail.payments" :key="payment._id">
                                                <td>{{ payment.trxid }}</td>
                                                <td>৳{{ payment.amount3.toFixed(2) }}</td>
                                                <td>{{ payment.status }}</td>
                                                <td>{{ formatDateTime(payment.createdAt) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <p v-else>No payments found for this user.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approve User Modal -->
        <div class="modal fade" id="approveUserModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Approve User & Set Commission</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Set the referral commission percentage and update user details for this user.</p>
                        <div v-if="selectedUser">
                            <div class="mb-3">
                                <label for="approve-name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="approve-name" v-model="selectedUser.name">
                            </div>
                            <div class="mb-3">
                                <label for="approve-zilla" class="form-label">Zilla</label>
                                <input type="text" class="form-control" id="approve-zilla" v-model="selectedUser.zilla">
                            </div>
                            <div class="mb-3">
                                <label for="approve-officeLocation" class="form-label">Office Location</label>
                                <input type="text" class="form-control" id="approve-officeLocation" v-model="selectedUser.officeLocation">
                            </div>
                            <div class="mb-3">
                                <label for="commission-percentage" class="form-label">Commission Percentage</label>
                                <input type="number" class="form-control" id="commission-percentage" v-model.number="commissionPercentage" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="approveUser">Approve User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Premium Payment Modal -->
        <div class="modal fade" id="processPremiumModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Process Premium Payment & Generate Voucher</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedPremiumPayment">
                            <p><strong>Phone:</strong> {{ selectedPremiumPayment.phone }}</p>
                            <div class="mb-3">
                                <label for="premium-discount-percentage" class="form-label">Discount Percentage</label>
                                <input type="number" class="form-control" id="premium-discount-percentage" v-model.number="premiumDiscountPercentage" min="0" max="100">
                            </div>
                            <div class="mb-3">
                                <label for="premium-validity-modal" class="form-label">Validity Period</label>
                                <select class="form-select" id="premium-validity-modal" v-model="premiumValidity">
                                    <option value="1d">1 Day</option>
                                    <option value="2d">2 Days</option>
                                    <option value="3d">3 Days</option>
                                    <option value="15d">15 Days</option>
                                    <option value="1m">1 Month</option>
                                    <option value="3m">3 Months</option>
                                    <option value="lifetime">Lifetime</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="processPremiumPayment">Generate Voucher</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fexiload Request Details Modal -->
        <div class="modal fade" id="fexiloadRequestModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Fexiload Request Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedFexiloadRequest">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Request ID</label>
                                        <input type="text" class="form-control" :value="selectedFexiloadRequest._id" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" v-model="selectedFexiloadRequest.status">
                                            <option value="Pending">Pending</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Failed">Failed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">User Email</label>
                                        <input type="text" class="form-control" 
                                               :value="(selectedFexiloadRequest.userId && selectedFexiloadRequest.userId.email) || 'N/A'" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">User Phone</label>
                                        <input type="text" class="form-control" 
                                               :value="(selectedFexiloadRequest.userId && selectedFexiloadRequest.userId.phone) || 'N/A'" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">GP Number</label>
                                        <input type="text" class="form-control" :value="selectedFexiloadRequest.gpNumber" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Recharge Amount/Offer</label>
                                        <input type="text" class="form-control" :value="selectedFexiloadRequest.rechargeAmount" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Transaction Number (TRX ID)</label>
                                <input type="text" class="form-control" :value="selectedFexiloadRequest.transactionNumber" readonly>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Requested On</label>
                                        <input type="text" class="form-control" :value="formatDateTime(selectedFexiloadRequest.createdAt)" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Last Updated</label>
                                        <input type="text" class="form-control" :value="formatDateTime(selectedFexiloadRequest.updatedAt)" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" @click="saveFexiloadRequestChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Tracker Request Details Modal -->
        <div class="modal fade" id="locationTrackerRequestModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Location Tracker Request Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedLocationTrackerRequest">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Request ID</label>
                                        <input type="text" class="form-control" :value="selectedLocationTrackerRequest._id" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" v-model="selectedLocationTrackerRequest.status">
                                            <option value="Pending">Pending</option>
                                            <option value="Approved">Approved</option>
                                            <option value="Rejected">Rejected</option>
                                            <option value="Completed">Completed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">User Email</label>
                                        <input type="text" class="form-control"
                                               :value="(selectedLocationTrackerRequest.user && selectedLocationTrackerRequest.user.email) || 'N/A'" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">User Phone</label>
                                        <input type="text" class="form-control"
                                               :value="(selectedLocationTrackerRequest.user && selectedLocationTrackerRequest.user.phone) || 'N/A'" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Source Type</label>
                                        <input type="text" class="form-control" :value="selectedLocationTrackerRequest.sourceType" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">IMEI / Phone Number</label>
                                        <input type="text" class="form-control"
                                               :value="selectedLocationTrackerRequest.imei || selectedLocationTrackerRequest.phoneNumber || 'N/A'" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3" v-if="selectedLocationTrackerRequest.lastUsedPhoneNumber">
                                <label class="form-label">Last Used Phone Number (IMEI)</label>
                                <input type="text" class="form-control" :value="selectedLocationTrackerRequest.lastUsedPhoneNumber" readonly>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Requested Data Types</label>
                                <input type="text" class="form-control" :value="selectedLocationTrackerRequest.dataNeeded.join(', ')" readonly>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Service Types (Backend)</label>
                                <input type="text" class="form-control" :value="selectedLocationTrackerRequest.serviceTypes.join(', ')" readonly>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Additional Note</label>
                                <textarea class="form-control" rows="3" readonly>{{ selectedLocationTrackerRequest.additionalNote || 'N/A' }}</textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Service Charge</label>
                                        <input type="text" class="form-control" :value="selectedLocationTrackerRequest.serviceCharge.toFixed(2)" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Payment Method</label>
                                        <input type="text" class="form-control" :value="selectedLocationTrackerRequest.paymentMethod" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">TRX ID</label>
                                        <input type="text" class="form-control" :value="selectedLocationTrackerRequest.trxId" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Requested On</label>
                                        <input type="text" class="form-control" :value="formatDateTime(selectedLocationTrackerRequest.createdAt)" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Last Updated</label>
                                        <input type="text" class="form-control" :value="formatDateTime(selectedLocationTrackerRequest.updatedAt)" readonly>
                                    </div>
                                </div>
                            </div>

                            <h6 class="mt-4">Delivered Data</h6>
                            <div v-if="selectedLocationTrackerRequest.deliveredData && selectedLocationTrackerRequest.deliveredData.length > 0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Data Type</th>
                                                <th>Content</th>
                                                <th>Delivered By</th>
                                                <th>Delivered At</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="data in selectedLocationTrackerRequest.deliveredData" :key="data._id">
                                                <td>{{ data.dataType }}</td>
                                                <td>{{ JSON.stringify(data.dataContent) }}</td>
                                                <td>{{ data.deliveredBy ? data.deliveredBy.email : 'N/A' }}</td>
                                                <td>{{ formatDateTime(data.deliveredAt) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <p v-else class="text-muted">No data delivered yet for this request.</p>

                            <div class="mb-3">
                                <label class="form-label">Moderator Notes</label>
                                <textarea class="form-control" rows="3" v-model="selectedLocationTrackerRequest.moderatorNotes"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" @click="saveLocationTrackerRequestChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deliver Data Modal -->
        <div class="modal fade" id="deliverDataModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Deliver Data for Request: {{ selectedLocationTrackerRequest ? shortId(selectedLocationTrackerRequest._id) : '' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="selectedLocationTrackerRequest">
                            <p><strong>Requested Data Types:</strong> {{ selectedLocationTrackerRequest.dataNeeded.join(', ') }}</p>
                            <div class="mb-3">
                                <label for="delivered-data-type" class="form-label">Data Type</label>
                                <select class="form-select" id="delivered-data-type" v-model="deliveredDataType">
                                    <option value="">Select Data Type</option>
                                    <option v-for="type in selectedLocationTrackerRequest.dataNeeded" :value="type">{{ type }}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="delivered-data-content" class="form-label">Data Content (JSON or Text)</label>
                                <textarea class="form-control" id="delivered-data-content" rows="5" v-model="deliveredDataContent" placeholder="Enter data content (e.g., {'latitude': 23.7, 'longitude': 90.3} or plain text)"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="submitDeliveredData">Submit Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://oneai-wjox.onrender.com';
        
        

        const AdminApp = {
            data() {
                return {
                    isLoading: true,
                    showInitialSetup: false,
                    isAuthenticated: false,
                    admin: { email: '', password: '' },
                    loginError: '',
                    loginLoading: false,
                    registerError: '',
                    registerSuccess: '',
                    registerLoading: false,
                    users: [],
                    payments: [],
                    merchantIssues: [],
                    penaltyReports: [],
                    premiumPayments: [],
                    fexiloadRequests: [], // New data array for Fexiload requests
                    commissionPercentage: 5,
                    locationTrackerRequests: [], // New data array for Location Tracker requests
                    selectedLocationTrackerRequest: null, // New data for selected Location Tracker request
                    locationTrackerRequestModal: null, // New modal for Location Tracker requests
                    deliverDataModal: null, // New modal for delivering data
                    deliveredDataType: '',
                    deliveredDataContent: '',
                    selectedUserDetail: null,
                    userDetailsModal: null,
                    selectedUser: null,
                    discountPercentage: 10,
                    issueDiscountPercentage: 10,
                    premiumDiscountPercentage: 0,
                    premiumValidity: '15d',
                    manualPremiumDiscountPercentage: 0,
                    manualPremiumValidity: '15d',
                    manualPremiumPhoneNumber: '',
                    generatingPremiumVoucher: false,
                    premiumVoucherMessage: '',
                    premiumVoucherSuccess: false,
                    issueStatusChart: null,
                    issueTypeChart: null,
                    recentActivities: [],
                    ws: null,
                    wsConnectionAttempts: 0,
                    userEmailQuery: '',
                    userPaymentData: null,
                    userPaymentError: '',
                    paymentStartDate: '',
                    paymentEndDate: ''
                };
            },
            computed: {
                filteredPayments() {
                    if (this.paymentFilter === 'all') {
                        return this.payments;
                    }
                    return this.payments.filter(p => p.status === this.paymentFilter);
                },
                filteredIssues() {
                    if (this.issueFilter === 'all') {
                        return this.merchantIssues;
                    }
                    return this.merchantIssues.filter(issue => 
                        issue.status === this.issueFilter.replace('-', ' ')
                    );
                },
                filteredPenalties() {
                    if (this.penaltyFilter === 'all') {
                        return this.penaltyReports;
                    }
                    return this.penaltyReports.filter(report => 
                        report.status === this.penaltyFilter
                    );
                },
                totalPaymentAmount() {
                    return this.payments.filter(p => p.status === 'Completed').reduce((total, payment) => total + payment.amount3, 0);
                }
            },
            methods: {
                async checkInitialSetup() {
                    try {
                        this.isLoading = true;
                        const response = await axios.get(`${API_BASE}/admin/exists`);
                        this.showInitialSetup = !response.data.exists;
                    } catch (error) {
                        console.error('Admin check error:', error);
                        this.showInitialSetup = true;
                    } finally {
                        this.isLoading = false;
                    }
                },
                validateEmail(email) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                },
                validatePassword(password) {
                    return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{12,}$/.test(password);
                },
                async registerAdmin() {
                    this.registerError = '';
                    this.registerSuccess = '';
                    this.registerLoading = true;
                    
                    if (!this.validateEmail(this.admin.email)) {
                        this.registerError = 'Please enter a valid email address';
                        this.registerLoading = false;
                        return;
                    }
                    
                    if (!this.validatePassword(this.admin.password)) {
                        this.registerError = 'Password must be at least 12 characters with uppercase, lowercase, number and special character';
                        this.registerLoading = false;
                        return;
                    }

                    try {
                        const response = await axios.post(`${API_BASE}/admin/register`, {
                            email: this.admin.email.trim(),
                            password: this.admin.password
                        });

                        if (response.data.success) {
                            this.registerSuccess = 'Admin account created! Redirecting...';
                            setTimeout(() => {
                                this.showInitialSetup = false;
                                this.isAuthenticated = true;
                                this.loadData();
                            }, 1500);
                        } else {
                            this.registerError = response.data.message;
                        }
                    } catch (error) {
                        this.registerError = (error.response && error.response.data && error.response.data.message) 
                            || 'Registration failed. Please try again.';
                    } finally {
                        this.registerLoading = false;
                    }
                },
                async login() {
                    console.log('Attempting login...');
                    this.loginError = '';
                    this.loginLoading = true;
                    
                    try {
                        const response = await axios.post(`${API_BASE}/admin/login`, this.admin);
                        console.log('Login response:', response.data);
                        
                        if (response.data.success) {
                            localStorage.setItem('adminToken', response.data.token);
                            this.isAuthenticated = true;
                            console.log('Login successful, isAuthenticated:', this.isAuthenticated);
                            await this.loadData();
                        } else {
                            this.loginError = response.data.message || 'Login failed. Please check your credentials.';
                            console.log('Login failed:', this.loginError);
                        }
                    } catch (error) {
                        console.error('Login error caught:', error);
                        
                        // Improved error handling
                        if (error.response) {
                            // Server responded with error status
                            this.loginError = error.response.data.message || 
                                             `Server error: ${error.response.status}`;
                        } else if (error.request) {
                            // Request was made but no response received
                            this.loginError = 'No response from server. Please check your connection.';
                        } else {
                            // Other errors
                            this.loginError = 'Login failed. Please try again.';
                        }
                    } finally {
                        this.loginLoading = false;
                        console.log('Login process finished, loginLoading:', this.loginLoading);
                    }
                },
                async loadData() {
                    console.log('Starting loadData...');
                    this.isLoading = true;
                    const token = localStorage.getItem('adminToken');
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    console.log('Authorization token set.');

                    const promises = [
                        this.loadUsers(),
                        this.loadPayments(),
                        this.loadMerchantIssues(),
                        this.loadPenaltyReports(),
                        this.loadPremiumPayments(),
                        this.loadFexiloadRequests(),
                        this.loadLocationTrackerRequests()
                    ];
                    console.log('All data loading promises initiated.');

                    try {
                        await Promise.all(promises);
                        console.log('All data loaded successfully.');
                    } catch (error) {
                        console.error('Data loading error in loadData:', error);
                        if (error.response && error.response.status === 401) {
                            console.log('401 error, logging out.');
                            this.logout();
                        }
                    } finally {
                        this.stats = {
                            totalUsers: this.users.length,
                            totalPayments: this.payments.length,
                            pendingPayments: this.payments.filter(p => p.status === 'Pending').length,
                            issueReports: this.merchantIssues.length
                        };
                        this.updateCharts();
                        this.loadRecentActivities();
                        this.isLoading = false;
                        console.log('loadData finished, isLoading:', this.isLoading);
                    }
                },
                    
                    async loadUsers() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/users`);
                            this.users = response.data.users || [];
                        } catch (error) {
                            console.error('Error loading users:', error);
                            this.users = [];
                        }
                    },
                    
                    async loadPayments() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/payments`);
                            this.payments = response.data.payments || [];
                        } catch (error) {
                            console.error('Error loading payments:', error);
                            this.payments = [];
                        }
                    },
                    
                    async loadMerchantIssues() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/merchant-issues`);
                            this.merchantIssues = response.data.issues || [];
                        } catch (error) {
                            console.error('Error loading merchant issues:', error);
                            this.merchantIssues = [];
                        }
                    },
                    
                    async loadPenaltyReports() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/penalty-reports`);
                            this.penaltyReports = response.data.reports || [];
                        } catch (error) {
                            console.error('Error loading penalty reports:', error);
                            this.penaltyReports = [];
                        }
                    },

                    async loadPremiumPayments() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/premium-services`);
                            this.premiumPayments = response.data.premiumServices || [];
                        } catch (error) {
                            console.error('Error loading premium payments:', error);
                            this.premiumPayments = [];
                        }
                    },

                    async loadFexiloadRequests() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/fexiload-requests`);
                            this.fexiloadRequests = response.data.fexiloadRequests || [];
                        } catch (error) {
                            console.error('Error loading fexiload requests:', error);
                            this.fexiloadRequests = [];
                        }
                    },

                    async loadLocationTrackerRequests() {
                        try {
                            const response = await axios.get(`${API_BASE}/admin/tracker/requests`);
                            this.locationTrackerRequests = response.data.requests || [];
                        } catch (error) {
                            console.error('Error loading location tracker requests:', error);
                            this.locationTrackerRequests = [];
                        }
                    },
                async refreshPayments() {
                    try {
                        this.isLoading = true;
                        const response = await axios.get(`${API_BASE}/admin/payments`);
                        this.payments = response.data.payments || [];
                        this.stats.pendingPayments = this.payments.filter(p => p.status === 'Pending').length;
                    } catch (error) {
                        console.error('Refresh payments error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async refreshUsers() {
                    try {
                        this.isLoading = true;
                        const response = await axios.get(`${API_BASE}/admin/users`);
                        this.users = response.data.users || [];
                        this.stats.totalUsers = this.users.length;
                    } catch (error) {
                        console.error('Refresh users error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async refreshIssues() {
                    try {
                        this.isLoading = true;
                        const response = await axios.get(`${API_BASE}/admin/merchant-issues`);
                        this.merchantIssues = response.data.issues || [];
                        this.stats.issueReports = this.merchantIssues.length;
                        this.updateCharts();
                    } catch (error) {
                        console.error('Refresh issues error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async refreshPenalties() {
                    try {
                        this.isLoading = true;
                        const response = await axios.get(`${API_BASE}/admin/penalty-reports`);
                        this.penaltyReports = response.data.reports || [];
                    } catch (error) {
                        console.error('Refresh penalties error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async refreshPremiumPayments() {
                    try {
                        this.isLoading = true;
                        await this.loadPremiumPayments();
                    } catch (error) {
                        console.error('Refresh premium payments error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async refreshFexiloadRequests() {
                    try {
                        this.isLoading = true;
                        await this.loadFexiloadRequests();
                    } catch (error) {
                        console.error('Refresh fexiload requests error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async refreshLocationTrackerRequests() {
                    try {
                        this.isLoading = true;
                        await this.loadLocationTrackerRequests();
                    } catch (error) {
                        console.error('Refresh location tracker requests error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                statusClass(status) {
                    const classes = {
                        'Pending': 'bg-warning',
                        'Completed': 'bg-success',
                        'Failed': 'bg-danger',
                        'pending': 'bg-warning',
                        'in progress': 'bg-info',
                        'resolved': 'bg-success',
                        'rejected': 'bg-danger'
                    };
                    return classes[status] || 'bg-secondary';
                },
                shortId(id) {
                    return id ? `${id.substring(0, 6)}...` : '';
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString();
                },
                formatDateTime(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleString();
                },
                logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('adminToken');
                        this.isAuthenticated = false;
                        this.admin = { email: '', password: '' };
                    }
                },
                async approvePayment(payment) {
                    await this.updatePaymentStatus(payment, 'Completed');
                },

                async rejectPayment(payment) {
                    await this.updatePaymentStatus(payment, 'Failed');
                },

                async updatePaymentStatus(payment, status) {
                    try {
                        this.isLoading = true;
                        
                        const response = await axios.post(
                            `${API_BASE}/admin/update-status`,
                            { trxid: payment.trxid, status: status }
                        );

                        if (response.data.success) {
                            const index = this.payments.findIndex(p => p._id === payment._id);
                            if (index > -1) {
                                this.payments.splice(index, 1, response.data.payment);
                            }
                            this.stats.pendingPayments = this.payments.filter(p => p.status === 'Pending').length;
                        }
                    } catch (error) {
                        console.error('Update status error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showPaymentDetails(payment) {
                    this.selectedPayment = payment;
                    if (!this.paymentModal) {
                        this.paymentModal = new bootstrap.Modal(
                            document.getElementById('paymentModal')
                        );
                    }
                    this.paymentModal.show();
                },
                async viewUserDetails(userId) {
                    try {
                        this.isLoading = true;
                        const response = await axios.get(`${API_BASE}/admin/users/${userId}/details`);
                        if (response.data.success) {
                            this.selectedUserDetail = response.data.user;
                            this.userDetailsModal.show();
                        }
                    } catch (error) {
                        console.error('Error fetching user details:', error);
                        alert('Failed to load user details.');
                        console.error('Full error response:', error.response);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showApproveUserModal(user) {
                    this.selectedUser = { ...user }; // Create a copy to avoid direct mutation
                    if (!this.approveUserModal) {
                        this.approveUserModal = new bootstrap.Modal(
                            document.getElementById('approveUserModal')
                        );
                    }
                    this.approveUserModal.show();
                },
                async approveUser() {
                    this.isLoading = true;
                    try {
                        const response = await axios.post(`${API_BASE}/admin/users/${this.selectedUser._id}/approve`, {
                            commissionPercentage: this.commissionPercentage,
                            name: this.selectedUser.name,
                            zilla: this.selectedUser.zilla,
                            officeLocation: this.selectedUser.officeLocation
                        });
                        if (response.data.success) {
                            const index = this.users.findIndex(u => u._id === this.selectedUser._id);
                            if (index > -1) {
                                this.users.splice(index, 1, response.data.user);
                            }
                            this.approveUserModal.hide();
                            alert('User approved and commission set successfully!'); // Success message
                        } else {
                            alert(response.data.message || 'Failed to approve user.'); // Error message
                        }
                    } catch (error) {
                        console.error('Approve user error:', error);
                        alert('Error approving user.'); // Generic error
                    } finally {
                        this.isLoading = false;
                    }
                },
                async generateReferralCode(user) {
                    this.isLoading = true;
                    try {
                        const response = await axios.post(`${API_BASE}/admin/users/${user._id}/generate-referral-code`);
                        if (response.data.success) {
                            const index = this.users.findIndex(u => u._id === user._id);
                            if (index > -1) {
                                this.users.splice(index, 1, response.data.user);
                            }
                            alert('Referral code generated successfully!'); // Success message
                        } else {
                            alert(response.data.message || 'Failed to generate referral code.'); // Error message
                        }
                    } catch (error) {
                        console.error('Generate referral code error:', error);
                        alert('Error generating referral code.'); // Generic error
                    } finally {
                        this.isLoading = false;
                    }
                },
                async updateIssueStatus(issue, status) {
                    try {
                        this.isLoading = true;
                        const response = await axios.put(
                            `${API_BASE}/admin/merchant-issues/${issue._id}/status`,
                            { status }
                        );

                        if (response.data.success) {
                            const index = this.merchantIssues.findIndex(i => i._id === issue._id);
                            if (index > -1) {
                                this.merchantIssues[index] = response.data.issue;
                            }
                            this.stats.issueReports = this.merchantIssues.length;
                            this.updateCharts();
                        }
                    } catch (error) {
                        console.error('Update issue status error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showIssueDetails(issue) {
                    this.selectedIssue = {...issue};
                    if (!this.issueModal) {
                        this.issueModal = new bootstrap.Modal(
                            document.getElementById('issueModal')
                        );
                    }
                    this.issueModal.show();
                },
                async saveIssueChanges() {
                    try {
                        this.isLoading = true;
                        const response = await axios.put(
                            `${API_BASE}/admin/merchant-issues/${this.selectedIssue._id}`,
                            this.selectedIssue
                        );

                        if (response.data.success) {
                            const index = this.merchantIssues.findIndex(i => i._id === this.selectedIssue._id);
                            if (index > -1) {
                                this.merchantIssues[index] = response.data.issue;
                            }
                            this.issueModal.hide();
                            this.updateCharts();
                        }
                    } catch (error) {
                        console.error('Save issue changes error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showPenaltyDetails(penalty) {
                    this.selectedPenalty = {...penalty};
                    if (!this.penaltyModal) {
                        this.penaltyModal = new bootstrap.Modal(
                            document.getElementById('penaltyModal')
                        );
                    }
                    this.penaltyModal.show();
                },
                async savePenaltyChanges() {
                    try {
                        this.isLoading = true;
                        const response = await axios.put(
                            `${API_BASE}/admin/penalty-reports/${this.selectedPenalty._id}`,
                            this.selectedPenalty
                        );

                        if (response.data.success) {
                            const index = this.penaltyReports.findIndex(r => r._id === this.selectedPenalty._id);
                            if (index > -1) {
                                this.penaltyReports[index] = response.data.report;
                            }
                            this.penaltyModal.hide();
                        }
                    } catch (error) {
                        console.error('Save penalty changes error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showApproveIssueModal(issue) {
                    this.selectedIssue = issue;
                    this.issueDiscountPercentage = 10; // Default discount
                    if (!this.approveIssueModal) {
                        this.approveIssueModal = new bootstrap.Modal(
                            document.getElementById('approveIssueModal')
                        );
                    }
                    this.approveIssueModal.show();
                },
                async approveIssue() {
                    try {
                        this.isLoading = true;
                        const response = await axios.post(`${API_BASE}/admin/issue-reports/${this.selectedIssue._id}/approve`, {
                            discountPercentage: this.issueDiscountPercentage
                        });
                        if (response.data.success) {
                            const index = this.merchantIssues.findIndex(i => i._id === this.selectedIssue._id);
                            if (index > -1) {
                                this.merchantIssues[index] = response.data.issue;
                            }
                            this.approveIssueModal.hide();
                        }
                    } catch (error) {
                        console.error('Approve issue error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showProcessPenaltyModal(penalty) {
                    this.selectedPenalty = penalty;
                    this.discountPercentage = 10;
                    if (!this.processPenaltyModal) {
                        this.processPenaltyModal = new bootstrap.Modal(
                            document.getElementById('processPenaltyModal')
                        );
                    }
                    this.processPenaltyModal.show();
                },
                async processPenalty() {
                    try {
                        this.isLoading = true;
                        const response = await axios.post(`${API_BASE}/admin/penalty-reports/${this.selectedPenalty._id}/process`, {
                            discountPercentage: this.discountPercentage
                        });
                        if (response.data.success) {
                            const index = this.penaltyReports.findIndex(r => r._id === this.selectedPenalty._id);
                            if (index > -1) {
                                this.penaltyReports[index] = response.data.report;
                            }
                            this.processPenaltyModal.hide();
                        }
                    } catch (error) {
                        console.error('Process penalty error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async updatePenaltyStatus(penalty, status) {
                    try {
                        this.isLoading = true;
                        const response = await axios.put(
                            `${API_BASE}/admin/penalty-reports/${penalty._id}/status`,
                            { status }
                        );

                        if (response.data.success) {
                            const index = this.penaltyReports.findIndex(r => r._id === penalty._id);
                            if (index > -1) {
                                this.penaltyReports[index] = response.data.report;
                            }
                        }
                    } catch (error) {
                        console.error('Update penalty status error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                showProcessPremiumModal(payment) {
                    this.selectedPremiumPayment = payment;
                    this.premiumDiscountPercentage = 0;
                    if (!this.processPremiumModal) {
                        this.processPremiumModal = new bootstrap.Modal(
                            document.getElementById('processPremiumModal')
                        );
                    }
                    this.processPremiumModal.show();
                },

                async processPremiumPayment() {
                    try {
                        this.isLoading = true;
                        const response = await axios.post(`${API_BASE}/admin/premium-payments/${this.selectedPremiumPayment._id}/process`, {
                            discountPercentage: this.premiumDiscountPercentage,
                            validity: this.premiumValidity
                        });
                        if (response.data.success) {
                            const index = this.premiumPayments.findIndex(p => p._id === this.selectedPremiumPayment._id);
                            if (index > -1) {
                                this.premiumPayments[index] = response.data.premiumService;
                            }
                            this.processPremiumModal.hide();
                        }
                    } catch (error) {
                        console.error('Process premium payment error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async updatePremiumPaymentStatus(payment, status) {
                    try {
                        this.isLoading = true;
                        const response = await axios.put(
                            `${API_BASE}/admin/premium-services/${payment._id}/status`,
                            { status }
                        );

                        if (response.data.success) {
                            const index = this.premiumPayments.findIndex(p => p._id === payment._id);
                            if (index > -1) {
                                this.premiumPayments[index] = response.data.premiumService;
                            }
                        }
                    } catch (error) {
                        console.error('Update premium payment status error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                showFexiloadRequestDetails(request) {
                    this.selectedFexiloadRequest = { ...request };
                    if (!this.fexiloadRequestModal) {
                        this.fexiloadRequestModal = new bootstrap.Modal(
                            document.getElementById('fexiloadRequestModal')
                        );
                    }
                    this.fexiloadRequestModal.show();
                },
                async saveFexiloadRequestChanges() {
                    try {
                        this.isLoading = true;
                        const response = await axios.put(
                            `${API_BASE}/admin/fexiload-requests/${this.selectedFexiloadRequest._id}/status`,
                            { status: this.selectedFexiloadRequest.status }
                        );

                        if (response.data.success) {
                            const index = this.fexiloadRequests.findIndex(r => r._id === this.selectedFexiloadRequest._id);
                            if (index > -1) {
                                this.fexiloadRequests[index] = response.data.fexiloadRequest;
                            }
                            this.fexiloadRequestModal.hide();
                        }
                    } catch (error) {
                        console.error('Save fexiload request changes error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },
                async showLocationTrackerRequestDetails(request) {
                    this.isLoading = true;
                    try {
                        const response = await axios.get(`${API_BASE}/api/location-tracker/delivered-data/${request._id}`);
                        if (response.data.success) {
                            this.selectedLocationTrackerRequest = { ...request, deliveredData: response.data.deliveredData };
                            if (!this.locationTrackerRequestModal) {
                                this.locationTrackerRequestModal = new bootstrap.Modal(
                                    document.getElementById('locationTrackerRequestModal')
                                );
                            }
                            this.locationTrackerRequestModal.show();
                        }
                    } catch (error) {
                        console.error('Error fetching location tracker request details:', error);
                        alert('Failed to load location tracker request details.');
                    } finally {
                        this.isLoading = false;
                    }
                },

                async saveLocationTrackerRequestChanges() {
                    this.isLoading = true;
                    try {
                        const response = await axios.put(
                            `${API_BASE}/admin/tracker/requests/${this.selectedLocationTrackerRequest._id}/status`,
                            { status: this.selectedLocationTrackerRequest.status, moderatorNotes: this.selectedLocationTrackerRequest.moderatorNotes }
                        );

                        if (response.data.success) {
                            const index = this.locationTrackerRequests.findIndex(r => r._id === this.selectedLocationTrackerRequest._id);
                            if (index > -1) {
                                this.locationTrackerRequests.splice(index, 1, response.data.request);
                            }
                            this.locationTrackerRequestModal.hide();
                        }
                    } catch (error) {
                        console.error('Save location tracker request changes error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async updateLocationTrackerRequestStatus(request, status) {
                    this.isLoading = true;
                    try {
                        const response = await axios.put(
                            `${API_BASE}/admin/tracker/requests/${request._id}/status`,
                            { status: status }
                        );

                        if (response.data.success) {
                            const index = this.locationTrackerRequests.findIndex(r => r._id === request._id);
                            if (index > -1) {
                                this.locationTrackerRequests.splice(index, 1, response.data.request);
                            }
                        }
                    } catch (error) {
                        console.error('Update location tracker request status error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                showDeliverDataModal(request) {
                    this.selectedLocationTrackerRequest = { ...request };
                    this.deliveredDataType = '';
                    this.deliveredDataContent = '';
                    if (!this.deliverDataModal) {
                        this.deliverDataModal = new bootstrap.Modal(
                            document.getElementById('deliverDataModal')
                        );
                    }
                    this.deliverDataModal.show();
                },

                async submitDeliveredData() {
                    this.isLoading = true;
                    try {
                        let dataContentParsed = this.deliveredDataContent;
                        try {
                            dataContentParsed = JSON.parse(this.deliveredDataContent);
                        } catch (e) {
                            // If not JSON, keep as string
                        }

                        const response = await axios.post(`${API_BASE}/admin/deliver-data`, {
                            requestId: this.selectedLocationTrackerRequest._id,
                            dataType: this.deliveredDataType,
                            dataContent: dataContentParsed
                        });

                        if (response.data.success) {
                            alert('Data delivered successfully!');
                            this.deliverDataModal.hide();
                            // Refresh the specific request to show delivered data and updated status
                            await this.showLocationTrackerRequestDetails(this.selectedLocationTrackerRequest);
                            // Also refresh the main list
                            await this.loadLocationTrackerRequests();
                        } else {
                            alert(response.data.message || 'Failed to deliver data.');
                        }
                    } catch (error) {
                        console.error('Submit delivered data error:', error);
                        alert('Error submitting data.');
                    } finally {
                        this.isLoading = false;
                    }
                },
                async generatePremiumVoucher() {
                    this.generatingPremiumVoucher = true;
                    this.premiumVoucherMessage = '';
                    this.premiumVoucherSuccess = false;
                    try {
                        const response = await axios.post(`${API_BASE}/admin/generate-premium-voucher`, {
                            phone: this.manualPremiumPhoneNumber,
                            discountPercentage: this.manualPremiumDiscountPercentage,
                            validity: this.manualPremiumValidity
                        });
                        if (response.data.success) {
                            this.premiumVoucherMessage = `Voucher generated: ${response.data.voucherCode} (Discount: ${response.data.discountPercentage}%, Valid until: ${new Date(response.data.validUntil).toLocaleDateString()})`;
                            this.premiumVoucherSuccess = true;
                        } else {
                            this.premiumVoucherMessage = response.data.message || 'Failed to generate voucher.';
                            this.premiumVoucherSuccess = false;
                        }
                    } catch (error) {
                        this.premiumVoucherMessage = (error.response && error.response.data && error.response.data.message) || 'Error generating voucher.';
                        this.premiumVoucherSuccess = false;
                    } finally {
                        this.generatingPremiumVoucher = false;
                    }
                },
                async deleteItem(type, id) {
                    const confirmation = prompt(`Type 'confirm' to delete this ${type}:`);
                    if (confirmation !== 'confirm') {
                        alert('Deletion cancelled.');
                        return;
                    }

                    try {
                        this.isLoading = true;
                        let url = '';
                        let successMessage = '';
                        let errorMessage = '';

                        switch (type) {
                            case 'user':
                                url = `${API_BASE}/admin/users/${id}`;
                                successMessage = 'User deleted successfully!';
                                errorMessage = 'Failed to delete user.';
                                break;
                            case 'payment':
                                url = `${API_BASE}/admin/payments/${id}`;
                                successMessage = 'Payment deleted successfully!';
                                errorMessage = 'Failed to delete payment.';
                                break;
                            case 'merchant issue':
                                url = `${API_BASE}/admin/merchant-issues/${id}`;
                                successMessage = 'Merchant issue deleted successfully!';
                                errorMessage = 'Failed to delete merchant issue.';
                                break;
                            case 'penalty report':
                                url = `${API_BASE}/admin/penalty-reports/${id}`;
                                successMessage = 'Penalty report deleted successfully!';
                                errorMessage = 'Failed to delete penalty report.';
                                break;
                            case 'fexiload request':
                                url = `${API_BASE}/admin/fexiload-requests/${id}`;
                                successMessage = 'Fexiload request deleted successfully!';
                                errorMessage = 'Failed to delete fexiload request.';
                                break;
                            case 'location tracker request':
                                url = `${API_BASE}/admin/tracker/requests/${id}`;
                                successMessage = 'Location tracker request deleted successfully!';
                                errorMessage = 'Failed to delete location tracker request.';
                                break;
                            default:
                                alert('Invalid item type for deletion.');
                                return;
                        }

                        const response = await axios.delete(url);

                        if (response.data.success) {
                            alert(successMessage);
                            // Refresh the relevant list
                            switch (type) {
                                case 'user':
                                    await this.loadUsers();
                                    break;
                                case 'payment':
                                    await this.loadPayments();
                                    break;
                                case 'merchant issue':
                                    await this.loadMerchantIssues();
                                    break;
                                case 'penalty report':
                                    await this.loadPenaltyReports();
                                    break;
                                case 'fexiload request':
                                    await this.loadFexiloadRequests();
                                    break;
                                case 'location tracker request':
                                    await this.loadLocationTrackerRequests();
                                    break;
                            }
                        } else {
                            alert(response.data.message || errorMessage);
                        }
                    } catch (error) {
                        console.error(`Error deleting ${type}:`, error);
                        alert(`Error deleting ${type}.`);
                    } finally {
                        this.isLoading = false;
                    }
                },
                loadRecentActivities() {
                    // This would normally come from an API
                    this.recentActivities = [
                        { id: 'act001', message: 'Updated payment status for TRX123456', timestamp: new Date() },
                        { id: 'act002', message: 'Resolved issue with Shop C', timestamp: new Date(Date.now() - 3600000) },
                        { id: 'act003', message: 'Added new admin note to issue ISS001', timestamp: new Date(Date.now() - 7200000) }
                    ];
                },
                updateCharts() {
                    // Issue status chart
                    const statusCounts = {
                        'pending': this.merchantIssues.filter(i => i.status === 'pending').length,
                        'in progress': this.merchantIssues.filter(i => i.status === 'in progress').length,
                        'resolved': this.merchantIssues.filter(i => i.status === 'resolved').length,
                        'rejected': this.merchantIssues.filter(i => i.status === 'rejected').length
                    };
                    
                    const statusCtx = document.getElementById('issueStatusChart');
                    if (this.issueStatusChart) {
                        this.issueStatusChart.destroy();
                    }
                    this.issueStatusChart = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Pending', 'In Progress', 'Resolved', 'Rejected'],
                            datasets: [{
                                data: Object.values(statusCounts),
                                backgroundColor: [
                                    'rgba(255, 193, 7, 0.8)',
                                    'rgba(23, 162, 184, 0.8)',
                                    'rgba(40, 167, 69, 0.8)',
                                    'rgba(220, 53, 69, 0.8)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    
                    // Issue type chart
                    const types = [...new Set(this.merchantIssues.map(i => i.issueType))];
                    const typeCounts = types.map(type => 
                        this.merchantIssues.filter(i => i.issueType === type).length
                    );
                    
                    const typeCtx = document.getElementById('issueTypeChart');
                    if (this.issueTypeChart) {
                        this.issueTypeChart.destroy();
                    }
                    this.issueTypeChart = new Chart(typeCtx, {
                        type: 'bar',
                        data: {
                            labels: types,
                            datasets: [{
                                label: 'Number of Issues',
                                data: typeCounts,
                                backgroundColor: 'rgba(78, 115, 223, 0.8)',
                                borderColor: 'rgba(78, 115, 223, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                },
                initWebSocket() {
                    if (this.ws) {
                        this.ws.close();
                        this.ws = null;
                    }

                    this.ws = new WebSocket('wss://oneai-wjox.onrender.com');
                    this.wsConnectionAttempts++;

                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        const token = localStorage.getItem('adminToken');
                        this.wsConnectionAttempts = 0;
                        
                        if (token) {
                            this.ws.send(JSON.stringify({
                                type: 'auth',
                                token: token
                            }));
                        }
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (data.type === 'payment-updated') {
                                const index = this.payments.findIndex(p => p.trxid === data.payment.trxid);
                                if (index > -1) {
                                    this.payments.splice(index, 1, {
                                        ...this.payments[index],
                                        status: data.payment.status
                                    });
                                }
                            } else if (data.type === 'new-payment') {
                                this.payments.unshift(data.payment);
                                this.stats.totalPayments = this.payments.length;
                                this.stats.pendingPayments = this.payments.filter(p => p.status === 'Pending').length;
                            } else if (data.type === 'new-issue') {
                                this.merchantIssues.unshift(data.issue);
                                this.stats.issueReports = this.merchantIssues.length;
                                this.updateCharts();
                            } else if (data.type === 'new-penalty') {
                                this.penaltyReports.unshift(data.report);
                            } else if (data.type === 'new-fexiload-request') {
                                this.fexiloadRequests.unshift(data.fexiloadRequest);
                            } else if (data.type === 'fexiload-updated') {
                                const index = this.fexiloadRequests.findIndex(r => r._id === data.fexiloadRequest._id);
                                if (index > -1) {
                                    this.fexiloadRequests.splice(index, 1, {
                                        ...this.fexiloadRequests[index],
                                        status: data.fexiloadRequest.status
                                    });
                                }
                            } else if (data.type === 'new-location-tracker-request') {
                                this.locationTrackerRequests.unshift(data.request);
                            } else if (data.type === 'location-tracker-updated') {
                                const index = this.locationTrackerRequests.findIndex(r => r._id === data.request._id);
                                if (index > -1) {
                                    this.locationTrackerRequests.splice(index, 1, {
                                        ...this.locationTrackerRequests[index],
                                        status: data.request.status,
                                        moderatorNotes: data.request.moderatorNotes
                                    });
                                }
                            }
                        } catch (error) {
                            console.error('WebSocket message error:', error);
                        }
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocket disconnected:', event.reason);
                        
                        if (this.wsConnectionAttempts < 5) {
                            console.log(`Reconnecting attempt ${this.wsConnectionAttempts}/5...`);
                            setTimeout(() => this.initWebSocket(), 3000);
                        } else {
                            console.error('Max WebSocket reconnection attempts reached');
                            this.wsConnectionAttempts = 0;
                        }
                    };
                },
                async calculateUserPayments() {
                    this.userPaymentData = null;
                    this.userPaymentError = '';
                    if (!this.userEmailQuery) {
                        this.userPaymentError = 'Please enter a user email.';
                        return;
                    }
                    try {
                        this.isLoading = true;
                        const params = {
                            email: this.userEmailQuery,
                            startDate: this.paymentStartDate,
                            endDate: this.paymentEndDate
                        };
                        const response = await axios.get(`${API_BASE}/admin/user-payments/${this.userEmailQuery}`, { params });
                        this.userPaymentData = response.data;
                    } catch (error) {
                        this.userPaymentError = (error.response && error.response.data && error.response.data.message) || 'Could not fetch user payment data.';
                    } finally {
                        this.isLoading = false;
                    }
                }
            },
            async mounted() {
                // Initialize modals
                this.paymentModal = new bootstrap.Modal(
                    document.getElementById('paymentModal'), 
                    { keyboard: false }
                );
                
                this.issueModal = new bootstrap.Modal(
                    document.getElementById('issueModal'), 
                    { keyboard: false }
                );
                
                this.penaltyModal = new bootstrap.Modal(
                    document.getElementById('penaltyModal'), 
                    { keyboard: false }
                );

                this.processPenaltyModal = new bootstrap.Modal(
                    document.getElementById('processPenaltyModal'),
                    { keyboard: false }
                );

                this.approveIssueModal = new bootstrap.Modal(
                    document.getElementById('approveIssueModal'),
                    { keyboard: false }
                );

                this.processPremiumModal = new bootstrap.Modal(
                    document.getElementById('processPremiumModal'),
                    { keyboard: false }
                );

                this.fexiloadRequestModal = new bootstrap.Modal(
                    document.getElementById('fexiloadRequestModal'),
                    { keyboard: false }
                );

                this.locationTrackerRequestModal = new bootstrap.Modal(
                    document.getElementById('locationTrackerRequestModal'),
                    { keyboard: false }
                );

                this.deliverDataModal = new bootstrap.Modal(
                    document.getElementById('deliverDataModal'),
                    { keyboard: false }
                );

                this.userDetailsModal = new bootstrap.Modal(
                    document.getElementById('userDetailsModal'),
                    { keyboard: false }
                );
                
                // Initialize tabs
                const triggerTabList = [].slice.call(document.querySelectorAll('#issueTabs button'));
                triggerTabList.forEach(triggerEl => {
                    const tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', event => {
                        event.preventDefault();
                        tabTrigger.show();
                    });
                });
                
                // Check initial setup
                await this.checkInitialSetup();
                
                // Check authentication if setup is done
                const token = localStorage.getItem('adminToken');
                if (token && !this.showInitialSetup) {
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    try {
                        // Validate token
                        await axios.get(`${API_BASE}/admin/validate`);
                        this.isAuthenticated = true;
                        
                        // Load data
                        this.loadData();
                        
                        // Init WebSocket
                        this.initWebSocket();
                    } catch (error) {
                        console.error('Authentication check failed:', error);
                        localStorage.removeItem('adminToken');
                    }
                }
            },
            beforeUnmount() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }
        };

        const app = Vue.createApp(AdminApp);
        app.mount('#admin-app');
    </script>
</body>
</html>
