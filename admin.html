<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Portal - Full Payment Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            margin: 0;
            padding: 20px;
            background: #f5f6fa;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .payment-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border-radius: 8px;
            overflow: hidden;
        }

        .payment-table th,
        .payment-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top;
        }

        .payment-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .password-cell {
            max-width: 200px;
            word-break: break-all;
        }

        .password-field {
            font-family: monospace;
            cursor: pointer;
            user-select: none;
        }

        .reveal-password {
            margin-left: 8px;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
            background: white;
            cursor: pointer;
            font-size: 0.8em;
        }

        .reveal-password:hover {
            background: #f8f9fa;
        }

        .consignment-details {
            margin: 4px 0;
            padding: 4px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        @media (max-width: 1200px) {
            .payment-table td:nth-child(6),
            .payment-table th:nth-child(6),
            .payment-table td:nth-child(9),
            .payment-table th:nth-child(9) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Full Payment Details Monitor</h1>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by TRX ID, Phone, or Name...">
            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
            </select>
        </div>

        <div class="loading-overlay" id="loading">
            <div class="spinner"></div>
            <span>Loading payment details...</span>
        </div>

        <table class="payment-table">
            <thead>
                <tr>
                    <th>TRX ID</th>
                    <th>Company</th>
                    <th>Phone</th>
                    <th>Password</th>
                    <th>Service Type</th>
                    <th>Consignments</th>
                    <th>Original Amt</th>
                    <th>Final Amt</th>
                    <th>Discount</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="paymentList">
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        const apiBase = 'https://your-server-domain.com';
        let allPayments = [];

        async function fetchPayments() {
            try {
                showLoading();
                const response = await fetch(`${apiBase}/admin/payments`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch payments');
                
                allPayments = await response.json();
                renderPayments(allPayments);
            } catch (error) {
                alert(error.message);
            } finally {
                hideLoading();
            }
        }

        function renderPayments(payments) {
            const tbody = document.getElementById('paymentList');
            tbody.innerHTML = '';

            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.trxid}</td>
                    <td>${payment.company}</td>
                    <td>${payment.phone}</td>
                    <td class="password-cell">
                        <span class="password-field" data-password="${payment.password}">•••••••</span>
                        <button class="reveal-password" onclick="togglePassword(this)">Show</button>
                    </td>
                    <td>${payment.serviceType}</td>
                    <td>
                        ${payment.consignments.map(c => `
                            <div class="consignment-details">
                                <strong>${c.name}</strong><br>
                                Phone: ${c.phone}<br>
                                Original: ৳${c.amount1.toFixed(2)}<br>
                                Updated: ৳${c.amount2.toFixed(2)}
                            </div>
                        `).join('')}
                    </td>
                    <td>৳${payment.originalAmount.toFixed(2)}</td>
                    <td>৳${payment.amount3.toFixed(2)}</td>
                    <td>${payment.discount}%</td>
                    <td>${payment.method}</td>
                    <td>
                        <select class="action-dropdown" data-trxid="${payment.trxid}" 
                                onchange="updateStatus('${payment.trxid}', this.value)">
                            <option value="pending" ${payment.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="completed" ${payment.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="failed" ${payment.status === 'failed' ? 'selected' : ''}>Failed</option>
                        </select>
                    </td>
                    <td>${new Date(payment.createdAt).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function togglePassword(button) {
            const span = button.previousElementSibling;
            if (span.textContent === '•••••••') {
                span.textContent = span.dataset.password;
                button.textContent = 'Hide';
                // Auto-hide after 30 seconds
                setTimeout(() => {
                    if (span.textContent !== '•••••••') {
                        span.textContent = '•••••••';
                        button.textContent = 'Show';
                    }
                }, 30000);
            } else {
                span.textContent = '•••••••';
                button.textContent = 'Show';
            }
        }
        async function updateStatus(trxid, newStatus) {
            try {
                const response = await fetch(`${apiBase}/admin/update-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ trxid, status: newStatus })
                });

                if (!response.ok) throw new Error('Status update failed');
                
                // Update local data
                const payment = allPayments.find(p => p.trxid === trxid);
                if (payment) payment.status = newStatus;
            } catch (error) {
                alert(error.message);
            }
        }

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterPayments);
        document.getElementById('statusFilter').addEventListener('change', filterPayments);

        function filterPayments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = allPayments.filter(payment => {
                const matchesSearch = payment.trxid.toLowerCase().includes(searchTerm) ||
                    payment.phone.toLowerCase().includes(searchTerm) ||
                    payment.consignments.some(c => c.name.toLowerCase().includes(searchTerm));

                const matchesStatus = !statusFilter || payment.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });

            renderPayments(filtered);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // WebSocket for real-time updates
        const ws = new WebSocket('wss://oneai-wjox.onrender.com');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'statusUpdate') {
                const index = allPayments.findIndex(p => p.trxid === data.payment.trxid);
                if (index > -1) {
                    allPayments[index] = data.payment;
                    filterPayments();
                }
            }
        };

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('adminToken')) {
                window.location.href = '/admin-login.html';
            }
            fetchPayments();
        });
    </script>
</body>
</html>
