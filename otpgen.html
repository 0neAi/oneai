<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>1ai Payment Gateway</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./assets/css/main.css">
</head>
<body class="is-preload">
  <div id="bg"></div>
  <h1>AI Payment Processor</h1>

  <header id="header">
    <h3>Bulk Service Payment</h3>
    <p>বিস্তারিত পূরণের পর পেমেন্ট এর পূর্বে ডিস্কাউন্ট বাটনে ক্লিক করে জিতেনিন ৪০% পর্যন্ত আকর্ষনীয় নগদ ডিসকাউন্ট </p>
  </header>

  <section>
    <h3>Service Credential Form</h3>
    <div id="discount-display" class="discount-banner">
      <i class="fas fa-tag"></i>
      <span id="discount-text">No active discount</span>
    </div>

    <form id="payment-form">
      <!-- Common Fields -->
      <div class="form-group">
        <label for="company">Company:</label>
        <select id="company" name="company" required>
          <option value="">Select available Company</option>
          <option value="govt_nid">Govt NID</option>
          <option value="redx">RedX</option>
          <option value="pathao">Pathao</option>
          <option value="steadfast">SteadFast</option>
        </select>
      </div>

      <div class="form-group">
        <label for="phone">App/Website Phone Number:</label>
        <input type="tel" id="phone" name="phone" required 
               pattern="01[3-9]\d{8}" 
               title="11-digit Bangladeshi phone number (013-019)">
      </div>

      <div class="form-group">
        <label for="password">NID/App Password:</label>
        <input type="text" id="password" name="password" required minlength="6">
      </div>
      <div class="form-group">
        <label for="serviceType">Service Type:</label>
        <select id="serviceType" name="serviceType" required>
          <option value="">Select Service</option>
          <option value="pricecng">Price Change</option>
          <option value="partial">Partial</option>
          <option value="nid">NID</option>
        </select>
      </div>

      <!-- Consignments Container -->
      <div id="consignments-container">
        <div class="consignment-group" data-index="0">
          <div class="consignment-counter">Consignment #1</div>
          <span class="remove-consignment" onclick="removeConsignment(this)">X</span>
          
          <div class="form-group">
            <label>Customer Details:</label>
            <input type="text" class="name" name="consignments[0][name]" placeholder="Name" required>
            <input type="tel" class="phone1" name="consignments[0][phone]" 
                   pattern="01[3-9]\d{8}" placeholder="01XXXXXXXXX" required>
          </div>

          <div class="amount-group">
            <div class="form-group">
              <label>Original Amount:</label>
              <input type="number" class="amount1" name="consignments[0][amount1]" 
                     min="100" max="100000" step="1" required>
            </div>
            
            <div class="form-group">
              <label>Updated Amount:</label>
              <input type="number" class="amount2" name="consignments[0][amount2]" 
                     min="100" max="100000" step="1" required>
            </div>
          </div>
        </div>
      </div>

      <button type="button" class="button add-consignment" onclick="addConsignment()">
        ＋ Add Another Consignment
      </button>

      <div class="form-group">
        <label for="amount3">Total Server Charge:</label>
        <input type="number" id="amount3" name="amount3" readonly required>
       <br> <small>কনফার্ম করতে সার্ভারচার্জ অগ্রিম পরিশোধ (send money) করুন</small>
        <small>নগদ পার্সোনাল: 01923002231</small>
      </div>
    <p>সার্ভার চার্জ প্রদানের পরে অনুগ্রহপূর্বক অপেক্ষা করুন,
      বিস্তারিত ফর্মে আপনার NID/REDX/PATHAO অথবা আপনার সার্ভিসের 
      লগইন/এপ এর ফোন নাম্বার এবং পাসওয়ার্ড সঠিক ভাবে প্রদান করুন। 
      আমাদের সার্ভিস ১০০ ভাগ নিরাপদ ও দ্রুত।
      আপনার এপ/ওয়েবসাইট লগ আউট হলে কমপক্ষে ১৫ মিনিট লগইন করা থেকে বিরত থাকুন, 
      পেমেন্ট এর ৪৫ মিনিট এর মধ্যে কোন আপডেট না পেলে / USDT পেমেন্টের জন্য
      হেল্পলাইনে যোগাযোগ করুন। অনুগ্রহ পূর্বক কিছুক্ষণ অপেক্ষা করুন,
    </p>
      <div class="form-group">
        <label for="method">Payment Method:</label>
        <select id="method" name="method" required>
          <option value="">Select Method</option>
          <option value="Bkash">Crypto(USDT)</option>
          <option value="Nagad">Nagad:01923002231</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="trxid">TRX ID:</label>
        <input type="text" id="trxid" name="trxid" required minlength="8">
      </div>

      <div class="form-actions">
        <button type="submit" class="button primary">Confirm Payment</button>
        <button type="button" class="button primary" onclick="clearForm()">Clear</button>
      </div>
    </form>

    <div id="confirmation-message" style="margin-top: 20px;"></div>
  </section>

<script>
// Initialize loading state
const loadingOverlay = document.createElement('div');
loadingOverlay.className = 'loading-overlay';
loadingOverlay.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x"></i>';
document.body.appendChild(loadingOverlay);

// Session Management
let isSubmitting = false;
let consignmentIndex = 1;

// Form Validation Utilities
const validatePhone = phone => /^01[3-9]\d{8}$/.test(phone);
const validateAmount = amount => amount >= 100 && amount <= 100000;

// Enhanced Form Submission Handler
document.getElementById('payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isSubmitting) return;

    try {
        // Check authentication
        const authToken = localStorage.getItem('authToken');
        const userID = localStorage.getItem('userID');
        if (!authToken || !userID) {
            window.location.href = 'login.html';
            return;
        }

        // Show loading state
        isSubmitting = true;
        loadingOverlay.style.display = 'flex';
        document.getElementById('confirmation-message').innerHTML = '';

        // Validate server status
        await checkServerStatus();

        // Collect and validate form data
        const formData = await validateAndPrepareData();

        // Submit to server
        const response = await fetch('https://oneai-wjox.onrender.com/payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`,
                'X-User-ID': userID
            },
            body: JSON.stringify(formData)
        });

        const responseData = await parseResponse(response);
        
        if (response.ok) {
            handleSuccess(responseData, formData);
        } else {
            handleServerError(responseData);
        }
    } catch (error) {
        handleNetworkError(error);
    } finally {
        isSubmitting = false;
        loadingOverlay.style.display = 'none';
    }
});

// Helper Functions
async function checkServerStatus() {
    const statusResponse = await fetch('https://oneai-wjox.onrender.com/status');
    if (!statusResponse.ok) throw new Error('Server unavailable');
}

async function validateAndPrepareData() {
    const form = document.getElementById('payment-form');
    const formData = {
        company: form.company.value,
        phone: form.phone.value.replace(/\D/g, ''),
        password: form.password.value.trim(),
        serviceType: form.serviceType.value,
        method: form.method.value,
        trxid: form.trxid.value.trim(),
        consignments: [],
        discount: parseInt(localStorage.getItem('activeDiscount')) || 0,
        status: 'Pending'
    };

    // Validate core fields
    if (!validatePhone(formData.phone)) {
        throw new Error('Invalid phone number format');
    }

    if (formData.trxid.length < 8) {
        throw new Error('TRX ID must be at least 8 characters');
    }

    // Process consignments
    let totalCharge = 0;
    document.querySelectorAll('.consignment-group').forEach((group, index) => {
        const consignment = {
            name: group.querySelector('.name').value.trim(),
            phone: group.querySelector('.phone1').value.replace(/\D/g, ''),
            amount1: parseFloat(group.querySelector('.amount1').value),
            amount2: parseFloat(group.querySelector('.amount2').value)
        };

        // Validate consignment data
        if (!consignment.name || !validatePhone(consignment.phone)) {
            throw new Error(`Consignment ${index + 1} has invalid data`);
        }

        if (!validateAmount(consignment.amount1) || !validateAmount(consignment.amount2)) {
            throw new Error(`Consignment ${index + 1} has invalid amounts`);
        }

        if (consignment.amount2 >= consignment.amount1) {
            throw new Error(`Consignment ${index + 1}: Updated amount must be less than original`);
        }

        totalCharge += (consignment.amount1 - consignment.amount2) / 2;
        formData.consignments.push(consignment);
    });

    // Apply discount
    if (formData.discount > 0) {
        totalCharge *= (1 - formData.discount / 100);
    }

    // Validate final amount
    formData.amount3 = parseFloat(totalCharge.toFixed(2));
    if (formData.amount3 < 100 || formData.amount3 > 30000) {
        throw new Error('Final amount must be between ৳100 and ৳30,000');
    }

    return formData;
}

async function parseResponse(response) {
    try {
        return await response.json();
    } catch {
        return { message: 'Invalid server response' };
    }
}

function handleSuccess(data, formData) {
    localStorage.setItem('recentPayment', JSON.stringify({
        company: formData.company,
        trxid: formData.trxid,
        amount: formData.amount3,
        status: 'Pending',
        timestamp: Date.now()
    }));

    showMessage('Payment successfully processed! Redirecting...', 'success');
    setTimeout(() => window.location.href = 'dashboard.html', 2000);
}

function handleServerError(responseData) {
    const errorMessage = responseData.message || 'Payment processing failed';
    showMessage(`Server Error: ${errorMessage}`, 'error');
    console.error('Server Error Details:', responseData);
}

function handleNetworkError(error) {
    const message = error.message.includes('Failed to fetch')
        ? 'Network Error: Check internet connection'
        : error.message;
    showMessage(`Error: ${message}`, 'error');
    console.error('Network Error:', error);
}

function showMessage(text, type) {
    const messageDiv = document.getElementById('confirmation-message');
    messageDiv.innerHTML = `
        <div class="alert-${type}">
            ${text}
        </div>
    `;
    setTimeout(() => messageDiv.innerHTML = '', 5000);
}

// Consignment Management
function addConsignment() {
    const container = document.getElementById('consignments-container');
    const newGroup = document.querySelector('.consignment-group').cloneNode(true);
    
    newGroup.querySelectorAll('input').forEach(input => {
        const name = input.name.replace('[0]', `[${consignmentIndex}]`);
        input.name = name;
        input.value = '';
    });
    
    newGroup.querySelector('.consignment-counter').textContent = `Consignment #${consignmentIndex + 1}`;
    container.appendChild(newGroup);
    consignmentIndex++;
    calculateTotalCharge();
}

function removeConsignment(element) {
    if (document.querySelectorAll('.consignment-group').length > 1) {
        element.closest('.consignment-group').remove();
        consignmentIndex--;
        calculateTotalCharge();
    }
}

function calculateTotalCharge() {
    let total = 0;
    document.querySelectorAll('.consignment-group').forEach(group => {
        const amount1 = parseFloat(group.querySelector('.amount1').value) || 0;
        const amount2 = parseFloat(group.querySelector('.amount2').value) || 0;
        total += (amount1 - amount2) / 2;
    });
    
    const discount = parseInt(localStorage.getItem('activeDiscount')) || 0;
    if (discount > 0) total *= (1 - discount / 100);
    
    document.getElementById('amount3').value = total.toFixed(2);
}

// Initialize form
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('consignments-container').addEventListener('input', calculateTotalCharge);
    calculateTotalCharge();
});
</script>
  <script src="./assets/js/load-navbar.js"></script>
  <script src="./assets/js/main.js"></script>
</body>
</html>
