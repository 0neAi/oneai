<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>1ai Fexiload Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./assets/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  .hidden {
    display: none !important;
  }
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    color: white;
    font-size: 2rem;
  }
  .alert-success {
    color: green;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 4px;
    margin: 10px 0;
  }
  .alert-error {
    color: red;
    padding: 10px;
    background: #ffebee;
    border-radius: 4px;
    margin: 10px 0;
  }
  .form-group {
    margin-bottom: 1.5rem;
  }
  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }
  .form-actions button {
    flex: 1;
  }
  .warning-message {
    background-color: #ffc107;
    color: #333;
    padding: 10px;
    border-radius: 5px;
    margin-top: 20px;
    text-align: center;
    font-weight: bold;
  }
</style>
</head>
<body class="is-preload">
  <div id="bg"></div>
  <h1>One Ai Fexiload Service</h1>

  <header id="header">
    <h3>Mobile Recharge Service</h3>
    <p>আপনার গ্রামীণফোন/স্কিটো নম্বরে রিচার্জ করুন।</p>
  </header>

  <section>
    <h3>INPUT DATA</h3>
    <form id="fexiload-form">
      <div class="form-group">
        <label for="gpNumber">GP/Skitto Number:</label>
        <input type="tel" id="gpNumber" name="gpNumber" required 
               pattern="01[7-9]\d{8}" 
               title="11-digit Grameenphone/Skitto number (017, 018, 019)" placeholder="01XXXXXXXXX">
      </div>

      <div class="form-group">
        <label for="rechargeAmount">Recharge Amount / Offer:</label>
        <input type="text" id="rechargeAmount" name="rechargeAmount" required placeholder="e.g., 200 BDT or 1GB 30 Days">
      </div>

      <div class="form-group">
        <label for="transactionNumber">Transaction Number (TRX ID):</label>
        <input type="text" id="transactionNumber" name="transactionNumber" required minlength="8" placeholder="Your payment TRX ID">
      </div>

      <div class="form-group">
        <input type="checkbox" id="terms-checkbox" name="terms" style="margin-right: 0.5rem;">
        <label for="terms-checkbox" style="display: inline-block; font-size: 0.9em; color: red; background-color: black; padding: 10px; border-radius: 5px; border: 1px solid red;">আমি উক্ত সার্ভিস গ্রহণের জন্য অনুরোধ করছি
          এবং এই সকল পরিবর্তনের সম্পুর্ন দায়ভার আমি গ্রহণ করছি। ওয়ানএআই ইন্টিলিজেন্স আমার অনুরোধকৃত পরিবর্তন সমূহের জন্য কোন ভাবেই দায়ীনয়।ভবিষ্যতে কোন ধরণের ইনকোয়েরি তে আমি এর দায়ভার সম্পুর্ণ নিজে বহন করার নিশ্চয়তা দিচ্ছি।আমি যদি সার্ভিসের গোপনীয়তা নষ্ট করি ওয়ান এআই আমার গোপনীয়তা
          রক্ষা করতে বাধ্য থাকবে না তা আমি অবগত থেকে উক্ত সার্ভিস গ্রহণের অনুরোধ জানাচ্ছি। উক্ত শর্তে রাজি থাকলে চেকবক্সে টিক দিন। </label>
      </div>

      <div class="form-actions">
        <button type="submit" class="button primary" id="submit-fexiload-button" disabled>Submit Recharge Request</button>
        <button type="button" class="button" onclick="clearForm()">Clear Form</button>
      </div>
      
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i> Maximum 30 minutes will be taken to success the recharge.
      </div>

      <div id="confirmation-message" style="margin-top: 20px;"></div>
    </form>
  </section>

  <script>
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'loading-overlay';
    loadingOverlay.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x"></i>';
    document.body.appendChild(loadingOverlay);

    let isSubmitting = false;

    function validateGpNumber(number) {
      return /^01[7-9]\d{8}$/.test(number);
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('confirmation-message');
      messageDiv.innerHTML = `<div class="alert-${type}">${message}</div>`;
      messageDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function clearForm() {
      if (confirm('Are you sure you want to clear the form?')) {
        document.getElementById('fexiload-form').reset();
        document.getElementById('submit-fexiload-button').disabled = true;
        document.getElementById('confirmation-message').innerHTML = '';
      }
    }

    document.getElementById('fexiload-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isSubmitting) return;

      try {
        const authToken = localStorage.getItem('authToken');
        const userID = localStorage.getItem('userID');
        const tokenExp = localStorage.getItem('tokenExp');

        if (!authToken || !userID || !tokenExp || Date.now() > parseInt(tokenExp)) {
          showMessage('Session expired or invalid. Please log in again.', 'error');
          localStorage.clear();
          setTimeout(() => { window.location.href = 'index.html'; }, 1500);
          return;
        }

        isSubmitting = true;
        loadingOverlay.style.display = 'flex';
        document.getElementById('confirmation-message').innerHTML = '';

        const gpNumber = document.getElementById('gpNumber').value.trim();
        const rechargeAmount = document.getElementById('rechargeAmount').value.trim();
        const transactionNumber = document.getElementById('transactionNumber').value.trim();

        if (!validateGpNumber(gpNumber)) {
          throw new Error('Invalid GP/Skitto number format.');
        }
        if (!rechargeAmount) {
          throw new Error('Recharge amount or offer is required.');
        }
        if (transactionNumber.length < 8) {
          throw new Error('Transaction number (TRX ID) must be at least 8 characters.');
        }

        const formData = {
          gpNumber,
          rechargeAmount,
          transactionNumber,
          userId: userID // Include userId for backend association
        };

        const response = await fetch('https://oneai-wjox.onrender.com/fexiload-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`,
            'X-User-ID': userID
          },
          body: JSON.stringify(formData)
        });

        const responseData = await response.json();
        
        if (response.ok) {
          const whatsappMessage = `
New Fexiload Request:
User ID: ${userID}
GP/Skitto Number: ${formData.gpNumber}
Recharge Amount/Offer: ${formData.rechargeAmount}
Transaction Number (TRX ID): ${formData.transactionNumber}
`.trim();

          window.open(`https://wa.me/8801568760780?text=${encodeURIComponent(whatsappMessage)}`, '_blank');

          showMessage('Fexiload request submitted successfully! Please wait up to 30 minutes for recharge.', 'success');
          setTimeout(() => window.location.href = 'dashboard.html', 3000);
        } else {
          showMessage(responseData.message || 'Fexiload request failed.', 'error');
        }
      } catch (error) {
        console.error('Fexiload submission error:', error);
        showMessage(error.message || 'An unexpected error occurred.', 'error');
      } finally {
        isSubmitting = false;
        loadingOverlay.style.display = 'none';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('terms-checkbox').addEventListener('change', function() {
        document.getElementById('submit-fexiload-button').disabled = !this.checked;
      });
    });
  </script>
  <script src="./assets/js/loading-animation.js"></script>
  <script src="./assets/js/load-navbar.js"></script>
  <script src="./assets/js/main.js"></script>
</body>
</html>